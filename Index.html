<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Firebase DMå¯¾å¿œãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª</title>
<style>
 body, html {
    height: 100%;
    margin: 0;
    font-family: sans-serif;
    }
 #app {
   display: flex;
   height: 100vh;
   }
 #leftPanel, #centerPanel, #rightPanel {
   background-color:#e7e7eb;
   padding: 10px;
   box-sizing: border-box;
   overflow-y: auto;
   }
 #leftPanel {
   color:white;
   flex: 1; width: 20%;
   border-right: 1px solid #ccc;
   background: #4c6473;
   }
 #centerPanel {
   color:white;
   background-color:#5c9291;
   flex: 2;
   width: 50%;
   border-right: 1px solid #eaf4fc;
   display: flex;
   flex-direction: column;
   }
 #rightPanel {
   background-color: #1f3134;
   color:white;
  flex: 1;
   width: 30%;
   }
   #myBioDisplay{
    color:white;
   }
 #chatBox {
   color:black;
   flex-grow: 1;
   border: 1px solid #ccc;
   padding: 5px;
   overflow-y: auto; background:#80aba9;
    }
 #messageForm {
   margin-top: 10px;
   display: flex;
   flex-wrap: wrap;
   gap: 10px;
   align-items: flex-end;
   }
 #messageInput {
   flex-grow: 1;
   padding: 5px;
   font-size: 16px;
   min-width: 100px;
   }
 button {
   display:flex;
   padding: 6px 12px;
   font-size: 16px;
   cursor: pointer;
   border: 1px solid white; background-color: #66cdaa; border-radius: 4px;
   color:white;
   }
 button:hover {
   background-color: #d0d0d0;
   }
 .roomItem {
   padding: 8px;
   border-bottom: 1px solid #ddd; cursor: pointer;
   display: flex;
   align-items: center; justify-content: space-between;
   }
 .roomItem.selected {
   background: #008899;
   }
 .room-list-icon {
   width: 25px;
   height: 25px;
   font-size: 0.9em;
   margin-right: 8px;
   border-radius: 50%;
   display: inline-flex;
   align-items: center; justify-content: center;
   color: white;
   text-transform: uppercase;
   flex-shrink: 0;
   }
 .unread-badge {
   background-color: #dc3545;
   color: white;
   font-size: 0.75em;
   padding: 2px 6px;
   border-radius: 12px;
   margin-left: 10px;
   min-width: 20px;
   text-align: center;
   }
 #searchResults {
  color:#43676b;
   max-height: 200px;
   overflow-y: auto;
   background: white;
   border: 1px solid #ccc; margin-bottom: 10px;
   margin-top: 5px;
   padding: 5px;
   }
 .searchUserItem {
   padding: 8px;
   border-bottom: 1px solid #eee; cursor: pointer;
   }
 .searchUserItem:last-child { border-bottom: none;
 }
 .searchUserItem:hover { background-color: #f0f0f0; }
 #loginForm {
   max-width: 300px;
   margin: 20px auto;
   padding: 20px;
   border: 1px solid #ccc; background: #f9f9f9; }
 #loginForm input[type="text"], #loginForm input[type="email"], #loginForm input[type="password"] {
   width: 100%;
   padding: 6px;
   margin: 6px 0 12px 0;
   box-sizing: border-box;
   }
 #groupCreationForm {
   padding: 10px;
   border: 1px solid #ccc;
   background-color: #53727d;
   margin-bottom: 15px;
   }
 #groupCreationForm input[type="text"] {
   width: calc(100% - 12px);
   padding: 5px;
   margin-bottom: 10px;
   }
 #selectedGroupMembers {
   border: 1px dashed #ccc;
   min-height: 30px;
   padding: 5px;
   margin-top: 5px;
   margin-bottom: 10px;
   }
 .selectedMemberTag {
   display: inline-block;
   background-color: #455765;
   padding: 3px 7px;
   margin: 3px;
   border-radius: 3px solid white;
   border: 1px soild white;
   font-size: 0.9em;
 }
 .selectedMemberTag button {
   background: none;
   border: none;
   color: #888;
   cursor: pointer;
   margin-left: 5px;
   padding: 0;
   font-size: 0.8em;
   }
 #btnLogout{
   background-color: #8f2e14;
 }
 .user-icon {
   width: 40px;
   height: 40px;
   border-radius: 50%;
   display: inline-flex;
   align-items: center;
   justify-content: center;
   font-size: 1.5em;
   font-weight: bold;
   color: white;
   text-transform: uppercase;
   margin-right: 10px;
   vertical-align: middle;
   flex-shrink: 0;
   border-radius: 3px soild white;
   }
 .chat-user-icon {
   width: 30px;
   height: 30px;
   font-size: 1.2em;
   margin-right: 5px;
   padding: 2px soild white;
    }
 .chat-message {
   display: flex;
   align-items: flex-start;
   margin-bottom: 10px;
   font-size: 1.0em
   }
 .message-content-wrapper { flex-grow: 1; }
 .message-header {
   display: flex;
   align-items: center;
   margin-bottom: 3px;
   color:white;
   font-size:0.5em;
   }
 .message-header span {
   font-size: 1.0em;
   color: white;
   margin-left: 5px;
   }
 .message-text {
   padding: 5px 10px;
   background-color: white;
   border-radius: 15px;
   display: inline-block;
   max-width: 80%;
   word-wrap: break-word;
   }
 #emojiPicker {
   display: grid;
   grid-template-columns: repeat(8, 1fr);
   gap: 5px; padding: 10px;
   border: 1px solid white;
   background: #fff; margin-top: 5px; margin-bottom: 10px; max-height: 150px; overflow-y: auto; display: none; width: 100%; box-sizing: border-box; }
 .emoji-button {
   font-size: 20px; background: none; border: none; cursor: pointer; padding: 2px; text-align: center;
   }
 .emoji-button:hover {
   background-color: #f0f0f0;
   }
 #toggleEmojiPicker { background-color: #f0f0f0; color: #333; font-size: 1.5em; line-height: 1; padding: 0 8px; }
 #toggleEmojiPicker:hover { background-color: #d0d0d0; }
 #profileEditForm { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
 #profileEditForm label { display: block; margin-bottom: 5px; font-weight: bold; }
 #profileEditForm input[type="text"], #profileEditForm input[type="color"], #profileEditForm textarea { width: calc(100% - 12px); padding: 5px; margin-bottom: 10px; box-sizing: border-box; }
 #profileEditForm textarea { resize: vertical; min-height: 60px; }
 #profileEditForm button { width: 100%; padding: 8px; background-color: #28a745; color: white; border: none; border-radius: 4px; }
 #profileEditForm button:hover { background-color: #218838; }
 #groupEditForm { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; display: none; }
 #groupEditForm label { display: block; margin-bottom: 5px; font-weight: bold; }
 #groupEditForm input[type="text"] { width: calc(100% - 12px); padding: 5px; margin-bottom: 10px; box-sizing: border-box; }
 #groupEditForm button { width: 100%; padding: 8px; background-color: #007bff; color: white; border: none; border-radius: 4px; margin-bottom: 5px; }
 #groupEditForm button:hover { background-color: #0056b3; }
 #btnRequestGroupDeletion { background-color: #dc3545; color: white; }
 #btnRequestGroupDeletion:hover { background-color: #c82333; }
 .group-member-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; padding: 5px; border: 1px solid #eee; border-radius: 4px; }
 .group-member-item button {
   background-color: #f0f0f0;
   color: #333;
   padding: 3px 8px;
   font-size: 0.8em;
   width: auto;
   }
 .group-member-item button:hover {
   background-color: #e0e0e0;
   }
 #groupMemberAddResults {
   max-height: 150px;
   overflow-y: auto;
   background: white;
   border: 1px solid #ccc;
   margin-bottom: 10px;
   margin-top: 5px;
   padding: 5px;
 }
 #groupDeletionStatus {
   margin-top: 10px;
   padding: 10px;
   border: 1px solid #ffc107;
   background-color: #fff3cd;
   color: #856404;
   border-radius: 4px;
   font-size: 0.9em;
   }
 #groupDeletionStatus button {
   margin-top: 5px;
   padding: 5px 10px;
   font-size: 0.9em;
   background-color: #007bff;
   color: white;
   }
 #groupDeletionStatus button.reject {
   background-color: #6c757d;
   }


#btnRequestGroupDeletion{
 color: #8f2e14;
}


</style>


<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>


</head>
<body>


<div id="loginScreen">
 <form id="loginForm" onsubmit="return false;">
   <h2>ãƒ­ã‚°ã‚¤ãƒ³ãƒ»æ–°è¦ç™»éŒ²</h2>
   <input type="text" id="regUsername" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆç™»éŒ²æ™‚ã®ã¿ï¼‰" />
   <input type="email" id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required />
   <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required />
   <button id="btnSignUp">ç™»éŒ²</button>
   <button id="btnLogin">ãƒ­ã‚°ã‚¤ãƒ³</button>
 </form>
</div>


<div id="app" style="display:none;">
 <div id="leftPanel">
   <h3>Rooms</h3>
   <div id="groupCreationForm">
       <h4>ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ</h4>
       <input type="text" id="groupNameInput" placeholder="ã‚°ãƒ«ãƒ¼ãƒ—å" />
       <input type="text" id="searchUserForGroupInput" placeholder="ãƒ¡ãƒ³ãƒãƒ¼ã‚’æ¤œç´¢ã—ã¦è¿½åŠ " style="width: calc(100% - 12px);" />
       <div id="groupMemberSearchResults"></div>
       <div id="selectedGroupMembers">
           <span class="selectedMemberTag" id="currentUserTag"></span>
       </div>
       <button id="btnCreateGroup">ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ</button>
   </div>
   <div>
     <input type="text" id="searchUserInput" placeholder="DMã—ãŸã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢" style="width: calc(70% - 6px);" />
     <button id="btnSearchUser" style="width: calc(30% - 6px);">æ¤œç´¢</button>
   </div>
   <div id="searchResults"></div>
   <h4 style="margin-top: 20px;">ChatRooms</h4>
   <div id="roomList"></div>
   <button id="btnLogout" style="margin-top: 20px; width: 100%;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
 </div>


 <div id="centerPanel">
   <h3 id="roomTitle">Chat Box</h3>
   <div id="chatBox">ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
   <form id="messageForm" onsubmit="handleSendMessage(); return false;">
     <button type="button" id="toggleEmojiPicker">ğŸ˜€</button>
     <input type="text" id="messageInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" autocomplete="off" />
     <button type="submit" id="btnSend">é€ä¿¡</button>
     <div id="emojiPicker" style="width: 100%; order: -1;"></div>
   </form>
 </div>


 <div id="rightPanel">
   <h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
   <div id="myProfileSection">
       <div id="profileContent">
           <div style="display: flex; align-items: center; margin-bottom: 10px;">
               <div id="myProfileIcon" class="user-icon"></div>
               <span id="myUsernameDisplay" style="font-size: 1.2em; font-weight: bold;"></span>
           </div>
           <p><strong>Email:</strong> <span id="myEmailDisplay"></span></p>
           <p><strong>Bio:</strong> <span id="myBioDisplay" style="white-space: pre-wrap; font-size: 0.9em; color: #white;"></span></p>
       </div>
       <div id="profileEditForm">
           <h4>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†</h4>
           <label for="editUsername">ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</label>
           <input type="text" id="editUsername" placeholder="æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼å" />
           <label for="editIconColor">ã‚¢ã‚¤ã‚³ãƒ³ã‚«ãƒ©ãƒ¼:</label>
           <input type="color" id="editIconColor" />
           <label for="editBio">bio:</label>
           <textarea id="editBio" placeholder="è‡ªå·±ç´¹ä»‹æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
           <button id="btnUpdateProfile">æ›´æ–°</button>
       </div>
   </div>
   <div id="groupEditForm">
       <h4>ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±ã‚’ç·¨é›†</h4>
       <label for="editGroupName">ã‚°ãƒ«ãƒ¼ãƒ—å:</label>
       <input type="text" id="editGroupName" placeholder="æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—å" />
       <button id="btnUpdateGroupProfile">ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±æ›´æ–°</button>
       <h4 style="margin-top: 15px;">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</h4>
       <input type="text" id="searchUserToAddGroupMember" placeholder="ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ " style="width: calc(100% - 12px);" />
       <div id="groupMemberAddResults"></div>
       <div style="margin-top: 10px;">
           <p><strong>ç¾åœ¨ã®ãƒ¡ãƒ³ãƒãƒ¼:</strong></p>
           <ul id="currentGroupMembers" style="list-style: none; padding: 0;"></ul>
       </div>
       <h4 style="margin-top: 15px;">ã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤</h4>
       <div id="groupDeletionStatus" style="display:none;"></div>
       <button id="btnRequestGroupDeletion">ã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</button>
   </div>
 </div>
</div>


<script>
 // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
 apiKey: "",
 authDomain: "",
 databaseURL: "",
 projectId: "",
 storageBucket: "",
 messagingSenderId: "",
 appId: "",
 measurementId: ""
}; 


 firebase.initializeApp(firebaseConfig);


 const auth = firebase.auth();
 const db = firebase.database();


 let loginScreen, app, inputUsername, inputEmail, inputPassword, btnSignUp, btnLogin;
 let roomListDiv, chatBox, roomTitle, profileContent, myProfileSection;
 let searchUserInput, searchResultsDiv, btnSearchUser, btnLogout, messageInput, btnSend;
 let groupNameInput, searchUserForGroupInput, groupMemberSearchResultsDiv, selectedGroupMembersDiv, currentUserTag, btnCreateGroup;
 let emojiPicker, toggleEmojiPickerBtn;
 let myProfileIcon, myUsernameDisplay, myEmailDisplay, myBioDisplay, editUsernameInput, editIconColorInput, editBioInput, btnUpdateProfile;
 let groupEditForm, editGroupNameInput, btnUpdateGroupProfile, searchUserToAddGroupMemberInput, groupMemberAddResultsDiv, currentGroupMembersList, btnRequestGroupDeletion, groupDeletionStatusDiv;


 let allRegisteredUsers = {};
 let selectedGroupMembers = {};


 let currentUser = null;
 let currentRoomId = null;
 let currentRoomData = null;
 let currentRoomType = null;
 let rooms = {};
 let currentRoomMessagesListener = null;
 let unreadCounts = {};
 let isRoomManuallySelected = false;
 let allUsersListener = null;
 let roomsListener = null;
 let unreadListener = null;




 document.addEventListener('DOMContentLoaded', () => {
   loginScreen = document.getElementById("loginScreen");
   app = document.getElementById("app");
   inputUsername = document.getElementById("regUsername");
   inputEmail = document.getElementById("email");
   inputPassword = document.getElementById("password");
   btnSignUp = document.getElementById("btnSignUp");
   btnLogin = document.getElementById("btnLogin");
   roomListDiv = document.getElementById("roomList");
   chatBox = document.getElementById("chatBox");
   roomTitle = document.getElementById("roomTitle");
   profileContent = document.getElementById("profileContent");
   myProfileSection = document.getElementById("myProfileSection");
   searchUserInput = document.getElementById("searchUserInput");
   searchResultsDiv = document.getElementById("searchResults");
   btnSearchUser = document.getElementById("btnSearchUser");
   btnLogout = document.getElementById("btnLogout");
   messageInput = document.getElementById("messageInput");
   btnSend = document.getElementById("btnSend");
   groupNameInput = document.getElementById("groupNameInput");
   searchUserForGroupInput = document.getElementById("searchUserForGroupInput");
   groupMemberSearchResultsDiv = document.getElementById("groupMemberSearchResults");
   selectedGroupMembersDiv = document.getElementById("selectedGroupMembers");
   currentUserTag = document.getElementById("currentUserTag");
   btnCreateGroup = document.getElementById("btnCreateGroup");
   emojiPicker = document.getElementById("emojiPicker");
   toggleEmojiPickerBtn = document.getElementById("toggleEmojiPicker");
   myProfileIcon = document.getElementById("myProfileIcon");
   myUsernameDisplay = document.getElementById("myUsernameDisplay");
   myEmailDisplay = document.getElementById("myEmailDisplay");
   myBioDisplay = document.getElementById("myBioDisplay");
   editUsernameInput = document.getElementById("editUsername");
   editIconColorInput = document.getElementById("editIconColor");
   editBioInput = document.getElementById("editBio");
   btnUpdateProfile = document.getElementById("btnUpdateProfile");
   groupEditForm = document.getElementById("groupEditForm");
   editGroupNameInput = document.getElementById("editGroupName");
   btnUpdateGroupProfile = document.getElementById("btnUpdateGroupProfile");
   searchUserToAddGroupMemberInput = document.getElementById("searchUserToAddGroupMember");
   groupMemberAddResultsDiv = document.getElementById("groupMemberAddResults");
   currentGroupMembersList = document.getElementById("currentGroupMembers");
   btnRequestGroupDeletion = document.getElementById("btnRequestGroupDeletion");
   groupDeletionStatusDiv = document.getElementById("groupDeletionStatus");


   setupEventListeners();
   initEmojiPicker();
 });


 function getRandomColor() {
     const letters = '0123456789ABCDEF';
     let color = '#';
     for (let i = 0; i < 6; i++) {
         color += letters[Math.floor(Math.random() * 16)];
     }
     return color;
 }


 function setupEventListeners() {
   btnSignUp.onclick = handleSignUp;
   btnLogin.onclick = handleLogin;
   btnLogout.onclick = handleLogout;
   // messageForm ã® onsubmit ã§ handleSendMessage ã‚’å‘¼ã¶ã®ã§ã€btnSend.onclick ã¯ä¸è¦
   // btnSend.onclick = handleSendMessage;
   btnSearchUser.onclick = handleSearchUser;
   searchUserInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSearchUser(); });
   searchUserForGroupInput.addEventListener('input', handleSearchUserForGroup); // ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ™‚ã®ãƒ¡ãƒ³ãƒãƒ¼æ¤œç´¢
   btnCreateGroup.onclick = handleCreateGroup;
   toggleEmojiPickerBtn.onclick = handleToggleEmojiPicker;
   btnUpdateProfile.onclick = handleUpdateProfile;
   btnUpdateGroupProfile.onclick = handleUpdateGroupProfile;
   searchUserToAddGroupMemberInput.addEventListener('input', handleSearchUserToAddGroupMember); // ã‚°ãƒ«ãƒ¼ãƒ—ç·¨é›†æ™‚ã®ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ æ¤œç´¢
   btnRequestGroupDeletion.onclick = handleRequestGroupDeletion;
 }


 async function handleSignUp() {
   const username = inputUsername.value.trim();
   const email = inputEmail.value.trim();
   const password = inputPassword.value.trim();
   if (!username) { alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç™»éŒ²æ™‚ã®ã¿ï¼‰"); return; }
   if (!email || !password) { alert("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
   try {
     const cred = await auth.createUserWithEmailAndPassword(email, password);
     await cred.user.updateProfile({ displayName: username });
     const initialColor = getRandomColor();
     await saveUserInfo(cred.user, initialColor, "");
     alert("ç™»éŒ²æˆåŠŸï¼ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã«ãªã‚Šã¾ã—ãŸã€‚");
     inputUsername.value = ""; inputEmail.value = ""; inputPassword.value = "";
   } catch (e) { alert("ç™»éŒ²ã‚¨ãƒ©ãƒ¼: " + e.message); console.error("Signup error:", e); }
 }


 async function saveUserInfo(user, color = null, bio = null) {
     const userData = {
         username: user.displayName,
         username_lower: user.displayName.toLowerCase(),
         email: user.email,
     };
     if (color !== null) userData.color = color;
     if (bio !== null) userData.bio = bio;
     try {
       await db.ref("users/" + user.uid).update(userData);
     } catch (error) {
       console.error("Error saving user info:", error);
     }
 }


 async function handleLogin() {
   const email = inputEmail.value.trim();
   const password = inputPassword.value.trim();
   if (!email || !password) { alert("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
   try {
     await auth.signInWithEmailAndPassword(email, password);
     inputEmail.value = ""; inputPassword.value = "";
   } catch (e) { alert("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: " + e.message); console.error("Login error:", e); }
 }


 async function handleLogout() {
   try {
     await auth.signOut();
   } catch (error) {
     console.error("Logout error:", error);
   }
 }


 auth.onAuthStateChanged(user => {
   console.log("Auth state changed. User:", user ? user.uid : "null");
   if (user) {
     currentUser = user;
     loginScreen.style.display = "none";
     app.style.display = "flex";
     if (currentUserTag) {
         currentUserTag.textContent = `${currentUser.displayName || "è‡ªåˆ†"}`;
         currentUserTag.dataset.uid = currentUser.uid;
     }
     if (roomTitle) roomTitle.textContent = "ãƒãƒ£ãƒƒãƒˆç”»é¢";
     selectedGroupMembers = { [currentUser.uid]: currentUser.displayName || "åŒ¿å" };
     updateSelectedGroupMembersUI();


     loadAllUsersData(); // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ç›£è¦–é–‹å§‹


     db.ref("users/" + currentUser.uid).once("value").then(snapshot => {
         const userData = snapshot.val();
         let userColor = userData?.color;
         let userBio = userData?.bio === undefined ? "" : userData.bio; // bioãŒundefinedãªã‚‰ç©ºæ–‡å­—åˆ—
         if (!userColor) {
             userColor = getRandomColor();
             db.ref("users/" + currentUser.uid).update({ color: userColor }).catch(e => console.error("Error saving initial color:", e));
         }
          if (userData?.bio === undefined) { // bioãŒæœªå®šç¾©ã§ã‚ã‚Œã°ç©ºæ–‡å­—åˆ—ã§ä¿å­˜
             db.ref("users/" + currentUser.uid).update({ bio: "" }).catch(e => console.error("Error saving initial bio:", e));
         }
         updateMyProfileDisplay(currentUser.displayName, userColor, userBio);
         if (editUsernameInput) editUsernameInput.value = currentUser.displayName || "";
         if (editIconColorInput) editIconColorInput.value = userColor;
         if (editBioInput) editBioInput.value = userBio;
     }).catch(error => {
         console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
         const defaultColor = getRandomColor();
         updateMyProfileDisplay(currentUser.displayName, defaultColor, "");
         if (editUsernameInput) editUsernameInput.value = currentUser.displayName || "";
         if (editIconColorInput) editIconColorInput.value = defaultColor;
         if (editBioInput) editBioInput.value = "";
     });


     isRoomManuallySelected = false;
     loadRooms(user.uid); // ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã¨ç›£è¦–é–‹å§‹
     setupUnreadCountListener(); // æœªèª­æ•°ãƒªã‚¹ãƒŠãƒ¼è¨­å®šã¨ç›£è¦–é–‹å§‹


   } else {
     currentUser = null;
     loginScreen.style.display = "block";
     app.style.display = "none";
     clearRoomList(); clearChat(); clearProfile();
     if (searchResultsDiv) searchResultsDiv.innerHTML = "";
     allRegisteredUsers = {}; selectedGroupMembers = {};
     if (groupMemberSearchResultsDiv) groupMemberSearchResultsDiv.innerHTML = "";
     if (groupNameInput) groupNameInput.value = "";
     if (searchUserForGroupInput) searchUserForGroupInput.value = "";
     if (currentUserTag) currentUserTag.innerHTML = "";


     if (currentRoomMessagesListener) { // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒŠãƒ¼è§£é™¤
         db.ref(`rooms/${currentRoomId}/messages`).off('child_added', currentRoomMessagesListener);
         currentRoomMessagesListener = null;
     }
     if (allUsersListener) { // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãƒªã‚¹ãƒŠãƒ¼è§£é™¤
       db.ref("users").off("value", allUsersListener);
       allUsersListener = null;
     }
     if (roomsListener) { // ãƒ«ãƒ¼ãƒ æƒ…å ±ãƒªã‚¹ãƒŠãƒ¼è§£é™¤
       db.ref("rooms").off("value", roomsListener);
       roomsListener = null;
     }
     if (unreadListener) { // æœªèª­æ•°ãƒªã‚¹ãƒŠãƒ¼è§£é™¤
       db.ref("rooms").off("value", unreadListener); // setupUnreadCountListener ã§ rooms ã‚’ç›£è¦–ã—ã¦ã„ã‚‹ã®ã§
       unreadListener = null;
     }
      // ã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤ãƒªã‚¹ãƒŠãƒ¼ã‚‚è§£é™¤ã—ã¦ãŠã (ç‰¹å®šã®ãƒ«ãƒ¼ãƒ IDã«ç´ã¥ããŸã‚ã€currentRoomIdãŒnullãªã‚‰ä¸è¦ã ãŒå¿µã®ãŸã‚)
     if (currentRoomId) {
         db.ref(`rooms/${currentRoomId}/deletionRequest`).off();
     }




     unreadCounts = {}; isRoomManuallySelected = false;
     if (myProfileIcon) { myProfileIcon.innerHTML = ""; myProfileIcon.style.backgroundColor = ""; }
     if (myUsernameDisplay) myUsernameDisplay.textContent = "";
     if (myEmailDisplay) myEmailDisplay.textContent = "";
     if (myBioDisplay) myBioDisplay.textContent = "";
     if (editUsernameInput) editUsernameInput.value = "";
     if (editIconColorInput) editIconColorInput.value = "#000000";
     if (editBioInput) editBioInput.value = "";
     if (groupEditForm) groupEditForm.style.display = 'none';
     if (myProfileSection) myProfileSection.style.display = 'block';
     currentRoomId = null; currentRoomData = null; currentRoomType = null; rooms = {};
   }
 });


 function loadAllUsersData() {
   if (allUsersListener) db.ref("users").off("value", allUsersListener); // å¤ã„ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
   allUsersListener = db.ref("users").on("value", snapshot => {
     allRegisteredUsers = snapshot.val() || {};
     renderRoomList(); // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå¤‰ã‚ã‚‹ã¨DMåãªã©ãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§å†æç”»
     if (currentUser && allRegisteredUsers[currentUser.uid]) {
         const myData = allRegisteredUsers[currentUser.uid];
         updateMyProfileDisplay(myData.username, myData.color, myData.bio);
         if (editUsernameInput) editUsernameInput.value = myData.username;
         if (editIconColorInput) editIconColorInput.value = myData.color || getRandomColor();
         if (editBioInput) editBioInput.value = myData.bio || "";
     }
     if (currentRoomId && rooms[currentRoomId]) { // ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ è¡¨ç¤ºã‚‚æ›´æ–°
         selectRoom({ id: currentRoomId, ...rooms[currentRoomId] });
     }
   }, error => console.error("Error loading all users data:", error));
 }


 function updateMyProfileDisplay(username, color, bio) {
     if (myProfileIcon) {
         if (username) {
             myProfileIcon.textContent = username.charAt(0).toUpperCase();
             myProfileIcon.style.backgroundColor = color || getRandomColor();
         } else {
             myProfileIcon.textContent = ""; myProfileIcon.style.backgroundColor = "";
         }
     }
     if (myUsernameDisplay) myUsernameDisplay.textContent = username || "";
     if (myEmailDisplay && currentUser) myEmailDisplay.textContent = currentUser.email || "";
     if (myBioDisplay) myBioDisplay.textContent = bio || "";
 }


 function loadRooms(uid) {
   const roomsQuery = db.ref("rooms").orderByChild(`members/${uid}`).equalTo(true);
   if (roomsListener) db.ref("rooms").off("value", roomsListener); // roomsRefã¯åºƒã™ãã‚‹ã®ã§ã‚¯ã‚¨ãƒªã«å¯¾ã—ã¦offã§ããªã„ã€‚ä¸€æ—¦å…¨è§£é™¤ã€‚


   roomsListener = roomsQuery.on("value", snapshot => {
     console.log("loadRooms: roomsRef onValue triggered. currentRoomId:", currentRoomId, "isRoomManuallySelected:", isRoomManuallySelected);
     rooms = snapshot.val() || {};
     renderRoomList();


     if (currentRoomId && !rooms[currentRoomId]) {
         console.log("loadRooms: Current room was deleted, clearing selection.");
         currentRoomId = null; currentRoomData = null; currentRoomType = null;
         clearChat();
         // clearProfile(); // è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¯æ®‹ã™
         if (groupEditForm) groupEditForm.style.display = 'none';
         if (myProfileSection) myProfileSection.style.display = 'block';
         isRoomManuallySelected = false;
     } else if (currentRoomId && rooms[currentRoomId]) {
         // é¸æŠä¸­ã®ãƒ«ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚ŒãŸå ´åˆã€å†é¸æŠã—ã¦UIæ›´æ–°
         selectRoom({ id: currentRoomId, ...rooms[currentRoomId] });
     } else if (!currentRoomId && Object.keys(rooms).length > 0 && !isRoomManuallySelected) {
         const firstRoomId = Object.keys(rooms)[0];
         console.log("loadRooms: Automatically selecting first room:", firstRoomId);
         selectRoom({ id: firstRoomId, ...rooms[firstRoomId] });
     }
   }, error => console.error("Error loading rooms:", error));
 }


 function setupUnreadCountListener() {
     if (unreadListener) db.ref("rooms").off("value", unreadListener); // å¤ã„ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤


     unreadListener = db.ref("rooms").on("value", async (snapshot) => {
         if (!currentUser) return;
         const allRoomsData = snapshot.val() || {};
         const newUnreadCounts = {};
         const unreadPromises = [];


         for (const roomId in allRoomsData) {
             const room = allRoomsData[roomId];
             if (!room.members || !room.members[currentUser.uid]) continue;


             const lastReadTimestamp = room.lastRead?.[currentUser.uid] || 0;
             const messagesRef = db.ref(`rooms/${roomId}/messages`);


             unreadPromises.push(
                 messagesRef.orderByChild('timestamp').startAt(lastReadTimestamp + 1).once('value')
                     .then(messagesSnapshot => {
                         let unreadCount = 0;
                         messagesSnapshot.forEach(messageChild => {
                             if (messageChild.val().uid !== currentUser.uid) unreadCount++;
                         });
                         newUnreadCounts[roomId] = unreadCount;
                     }).catch(e => console.error(`Error counting unread for ${roomId}:`, e))
             );
         }
         try {
           await Promise.all(unreadPromises);
           unreadCounts = newUnreadCounts;
           renderRoomList();
         } catch (error) {
           console.error("Error calculating unread counts:", error);
         }
     }, error => console.error("Error in unread count listener:", error));
 }




 function renderRoomList() {
   if (!roomListDiv || !currentUser) return;
   roomListDiv.innerHTML = "";
   Object.entries(rooms).sort(([,a], [,b]) => { // createdAtã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„ã‚‚ã®ãŒä¸Šï¼‰ã‚‚æ¤œè¨ã§ãã‚‹
       const timeA = Object.values(a.messages || {}).sort((x,y) => y.timestamp - x.timestamp)[0]?.timestamp || a.createdAt || 0;
       const timeB = Object.values(b.messages || {}).sort((x,y) => y.timestamp - x.timestamp)[0]?.timestamp || b.createdAt || 0;
       return timeB - timeA;
   }).forEach(([roomId, room]) => {
     if (!room.members || !room.members[currentUser.uid]) return;


     let roomDisplayName, roomIconHtml;
     const roomTypeToDisplay = room.type || (roomId.startsWith("dm_") ? "dm" : "group");


     if (roomTypeToDisplay === "dm") {
         const otherUid = Object.keys(room.members).find(uid => uid !== currentUser.uid);
         const otherUser = allRegisteredUsers[otherUid];
         if (!otherUser) { console.warn(`renderRoomList: Skipping DM room ${roomId}, other user ${otherUid} not found.`); return; }
         roomDisplayName = otherUser.username;
         const initial = otherUser.username.charAt(0).toUpperCase();
         const color = otherUser.color || getRandomColor();
         roomIconHtml = `<div class="user-icon room-list-icon" style="background-color: ${escapeHTML(color)};">${escapeHTML(initial)}</div>`;
     } else { // group or unknown (defaults to group icon)
         roomDisplayName = room.name || "åç§°æœªè¨­å®šã‚°ãƒ«ãƒ¼ãƒ—";
         const groupInitial = room.name ? room.name.charAt(0).toUpperCase() : 'G';
         const groupColor = room.iconColor || '#007bff'; // ã‚°ãƒ«ãƒ¼ãƒ—ã«ã‚‚ã‚¢ã‚¤ã‚³ãƒ³è‰²ã‚’æŒãŸã›ã‚‹ãªã‚‰
         roomIconHtml = `<div class="user-icon room-list-icon" style="background-color: ${escapeHTML(groupColor)};">${escapeHTML(groupInitial)}</div>`;
     }


     const div = document.createElement("div");
     div.className = "roomItem" + (roomId === currentRoomId ? " selected" : "");
     div.dataset.roomId = roomId;
     const unread = unreadCounts[roomId] || 0;
     const unreadBadgeHtml = unread > 0 ? `<span class="unread-badge">${unread}</span>` : '';
     div.innerHTML = `<div style="display: flex; align-items: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-grow: 1;">${roomIconHtml}<span style="overflow: hidden; text-overflow: ellipsis;">${escapeHTML(roomDisplayName)}</span></div> ${unreadBadgeHtml}`;
     div.onclick = () => {
         isRoomManuallySelected = true;
         selectRoom({ id: roomId, ...room });
     };
     roomListDiv.appendChild(div);
   });
 }


 let messageListenerCallback = null; // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ä¿æŒã—ã¦è§£é™¤ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹


 function selectRoom(room) {
   console.groupCollapsed("selectRoom called for room:", room.id);
   console.log("Full room object:", room);
   const newRoomId = room.id;
   let determinedRoomType = room.type || (newRoomId.startsWith("dm_") ? "dm" : "group");
   currentRoomType = determinedRoomType; // ã‚°ãƒ­ãƒ¼ãƒãƒ«æ›´æ–°


   if (!room.members) {
       console.error(`selectRoom: Room ${newRoomId} has no 'members' field.`);
       console.groupEnd();
       return;
   }


   // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
   if (currentRoomMessagesListener && messageListenerCallback) {
       console.log("Detaching old message listener for room:", currentRoomId);
       db.ref(`rooms/${currentRoomId}/messages`).off('child_added', messageListenerCallback);
       currentRoomMessagesListener = null;
       messageListenerCallback = null;
   }
   // æ—¢å­˜ã®ã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
   if (currentRoomId && groupDeletionStatusDiv) { // currentRoomId ãŒ null ã§ãªã„ã“ã¨ã‚’ç¢ºèª
       db.ref(`rooms/${currentRoomId}/deletionRequest`).off();
   }




   if (chatBox) chatBox.innerHTML = "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ä¸­..."; // åˆæœŸè¡¨ç¤º


   currentRoomId = newRoomId;
   currentRoomData = room; // roomå…¨ä½“ã‚’ä¿å­˜


   document.querySelectorAll('.roomItem').forEach(item => item.classList.remove('selected'));
   const selectedRoomElement = Array.from(roomListDiv.children).find(el => el.dataset.roomId === newRoomId);
   if (selectedRoomElement) selectedRoomElement.classList.add('selected');


   updateRoomTitle(room);


   if (currentRoomType === "group") {
       if (myProfileSection) myProfileSection.style.display = 'none';
       if (groupEditForm) groupEditForm.style.display = 'block';
       if (editGroupNameInput) editGroupNameInput.value = room.name || "";
       updateGroupMembersList(room.members);
       setupGroupDeletionListener(newRoomId); // æ–°ã—ã„ãƒ«ãƒ¼ãƒ IDã§ãƒªã‚¹ãƒŠãƒ¼è¨­å®š
   } else { // DM
       if (myProfileSection) myProfileSection.style.display = 'block';
       if (groupEditForm) groupEditForm.style.display = 'none';
       const otherUid = Object.keys(room.members).find(uid => uid !== currentUser.uid);
       const otherUser = allRegisteredUsers[otherUid];
       updateDMProfilePanel(otherUser);
   }


   // æœ€çµ‚æ—¢èª­ã‚’æ›´æ–° (ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°ãã®æœ€æ–°ã€ãªã‘ã‚Œã°ç¾åœ¨æ™‚åˆ»)
   db.ref(`rooms/${newRoomId}/messages`).orderByChild('timestamp').limitToLast(1).once('value', snapshot => {
       let lastTimestamp = firebase.database.ServerValue.TIMESTAMP;
       if (snapshot.exists()) {
           const lastMessage = Object.values(snapshot.val())[0];
           if (lastMessage) lastTimestamp = lastMessage.timestamp;
       }
       if (currentUser) {
            db.ref(`rooms/${newRoomId}/lastRead/${currentUser.uid}`).set(lastTimestamp)
               .catch(e => console.error("Error updating last read:", e));
       }
   });




   const messagesRef = db.ref(`rooms/${newRoomId}/messages`);
   chatBox.innerHTML = ""; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰å‰ã«ä¸€æ—¦ã‚¯ãƒªã‚¢


   // éå»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ (æœ€å¤§100ä»¶)
   messagesRef.orderByChild('timestamp').limitToLast(100).once('value', snapshot => {
       if (!snapshot.exists() || snapshot.numChildren() === 0) {
           if (chatBox) chatBox.textContent = "ã“ã®ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã«ã¯ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
       } else {
           if (chatBox) chatBox.innerHTML = ""; // å¿µã®ãŸã‚å†åº¦ã‚¯ãƒªã‚¢
           snapshot.forEach(childSnapshot => {
               appendMessageToChatbox(childSnapshot.key, childSnapshot.val());
           });
           if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
       }


       // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
       // å¤ã„ãƒªã‚¹ãƒŠãƒ¼ã¯æ—¢ã«è§£é™¤ã•ã‚Œã¦ã„ã‚‹ã¯ãš
       if (messageListenerCallback) { // äºŒé‡ç™»éŒ²é˜²æ­¢
           messagesRef.off('child_added', messageListenerCallback);
       }
       messageListenerCallback = (msgSnapshot) => { // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ä¿æŒ
           // æ—¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è¿½åŠ ã—ãªã„ (onceã§ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚‚ã®ã¨ã®é‡è¤‡å›é¿)
           if (chatBox.querySelector(`[data-message-id="${msgSnapshot.key}"]`)) return;
          
           if (chatBox.textContent === "ã“ã®ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã«ã¯ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“ã€‚") {
                if (chatBox) chatBox.innerHTML = "";
           }
           appendMessageToChatbox(msgSnapshot.key, msgSnapshot.val());
           if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;


           if (currentUser && msgSnapshot.val().uid !== currentUser.uid) {
               db.ref(`rooms/${newRoomId}/lastRead/${currentUser.uid}`).set(msgSnapshot.val().timestamp)
                   .catch(e => console.error("Error updating last read on new message:", e));
           }
       };
       currentRoomMessagesListener = messagesRef.orderByChild('timestamp').startAt(Date.now()) // åˆå›ãƒ­ãƒ¼ãƒ‰å¾Œã¯æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿å–å¾—ã™ã‚‹å·¥å¤«
                                            .on('child_added', messageListenerCallback, error => {
           console.error("Error in message listener for room", newRoomId, ":", error);
           if (chatBox) chatBox.textContent = "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å—ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
       });


   }, (error) => {
       console.error("Error loading initial messages for room", newRoomId, ":", error);
       if (chatBox) chatBox.textContent = "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
   });
   console.groupEnd();
 }


 function appendMessageToChatbox(messageId, data) {
     if (!chatBox || !currentUser) return;
     const div = document.createElement("div");
     div.className = "chat-message";
     div.dataset.messageId = messageId;
     const timestamp = data.timestamp ? new Date(data.timestamp).toLocaleString() : 'ä¸æ˜ãªæ™‚é–“';
     const senderInfo = allRegisteredUsers[data.uid];
     const senderUsername = senderInfo?.username || data.username || "ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼";
     const senderColor = senderInfo?.color || getRandomColor();
     const senderInitial = senderUsername.charAt(0).toUpperCase();


     div.innerHTML = `
       <div class="user-icon chat-user-icon" style="background-color: ${escapeHTML(senderColor)};" title="${escapeHTML(senderUsername)}">${escapeHTML(senderInitial)}</div>
       <div class="message-content-wrapper">
           <div class="message-header">
               <span>${escapeHTML(senderUsername)}</span> @ ${timestamp}
           </div>
           <div class="message-text">${escapeHTML(data.message)}</div>
       </div>`;
     chatBox.appendChild(div);
 }




 function updateDMProfilePanel(otherUser) {
     if (!profileContent || !myProfileSection) return;
     myProfileSection.style.display = 'block'; // è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
     if (!otherUser) {
         profileContent.innerHTML = `<h4>ç›¸æ‰‹æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h4><p>ã“ã®DMã®ç›¸æ‰‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å­˜åœ¨ã—ãªã„ã‹ã€ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>`;
     } else {
         // DMç›¸æ‰‹ã®æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹ã®ã§ã¯ãªãã€å¸¸ã«è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¡¨ç¤ºã—ã€ã‚°ãƒ«ãƒ¼ãƒ—ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’éš ã™
         // å³ãƒ‘ãƒãƒ«ã¯å¸¸ã«ã€Œè‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã€ã¾ãŸã¯ã€Œã‚°ãƒ«ãƒ¼ãƒ—ç·¨é›†ã€ã®ã©ã¡ã‚‰ã‹ãªã®ã§ã€DMé¸æŠæ™‚ã¯ã€Œè‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã€
         // updateMyProfileDisplay ã§è‡ªåˆ†ã®æƒ…å ±ã¯æ›´æ–°æ¸ˆã¿ã®ã¯ãš
         if (groupEditForm) groupEditForm.style.display = 'none'; // ã‚°ãƒ«ãƒ¼ãƒ—ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’éš ã™
     }
 }




 function updateRoomTitle(room) {
     if (!roomTitle || !currentUser) return;
     let displayRoomName = room.name;
     const determinedRoomType = room.type || (room.id.startsWith("dm_") ? "dm" : "group");


     if (determinedRoomType === "dm") {
         const otherUid = Object.keys(room.members || {}).find(uid => uid !== currentUser.uid);
         const otherUser = allRegisteredUsers[otherUid];
         displayRoomName = `DM: ${otherUser ? otherUser.username : (room.name || "ç›¸æ‰‹ä¸æ˜")}`;
     } else if (determinedRoomType === "group") {
         displayRoomName = `ã‚°ãƒ«ãƒ¼ãƒ—: ${room.name || "åç§°æœªè¨­å®šã‚°ãƒ«ãƒ¼ãƒ—"}`;
     } else {
         displayRoomName = room.name || "ãƒãƒ£ãƒƒãƒˆ";
     }
     roomTitle.textContent = displayRoomName;
 }


 function handleSendMessage() {
    const msg = messageInput.value.trim();
    if (!msg || !currentUser) return;
    sendMessage(msg);
    messageInput.value = "";
    if (emojiPicker.style.display === 'grid') { // é€ä¿¡å¾Œçµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ã‚’é–‰ã˜ã‚‹
       emojiPicker.style.display = 'none';
    }
 }


 function sendMessage(text) {
   if (!currentRoomId) { console.error("sendMessage: currentRoomId is null."); alert("ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"); return; }
   if (!currentUser) { console.error("sendMessage: currentUser is null."); return; }
   console.log(`sendMessage: Room ${currentRoomId}, User ${currentUser.uid}, Message: ${text}`);
   db.ref(`rooms/${currentRoomId}/messages`).push({
     username: currentUser.displayName || "åŒ¿å",
     uid: currentUser.uid,
     message: text,
     timestamp: firebase.database.ServerValue.TIMESTAMP
   }).then(() => {
       console.log("Message sent successfully to room:", currentRoomId);
   }).catch(error => {
       console.error("Message sending error:", error);
       alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
   });
 }


 function handleSearchUser() {
   const keyword = searchUserInput.value.trim().toLowerCase();
   if (!searchResultsDiv) return;
   searchResultsDiv.innerHTML = "";
   if (!keyword) return;


   let usersFound = false;
   Object.entries(allRegisteredUsers).forEach(([uid, user]) => {
     if (uid === currentUser.uid || !user.username_lower) return;
     if (user.username_lower.includes(keyword)) {
         usersFound = true;
         const div = document.createElement("div");
         div.className = "searchUserItem";
         div.textContent = user.username;
         div.onclick = () => {
             createOrSelectDMRoom(uid, user.username);
             if (searchUserInput) searchUserInput.value = "";
             if (searchResultsDiv) searchResultsDiv.innerHTML = "";
         };
         searchResultsDiv.appendChild(div);
     }
   });
   if (!usersFound) searchResultsDiv.textContent = "è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
 }


 function createOrSelectDMRoom(otherUserId, otherUsername) {
   if (!currentUser) return;
   const currentUserId = currentUser.uid;
   const roomId = currentUserId < otherUserId ? `dm_${currentUserId}_${otherUserId}` : `dm_${otherUserId}_${currentUserId}`;
   const roomRef = db.ref("rooms/" + roomId);


   roomRef.once("value").then(snapshot => {
     if (!snapshot.exists()) {
       const newMembers = {};
       newMembers[currentUserId] = true;
       newMembers[otherUserId] = true;
       roomRef.set({
         type: "dm",
         members: newMembers,
         name: `DM with ${otherUsername}`, // DMãƒ«ãƒ¼ãƒ åã‚‚ä¸€å¿œè¨­å®š
         createdAt: firebase.database.ServerValue.TIMESTAMP,
         createdBy: currentUserId
       }).then(() => {
           console.log("New DM room created:", roomId);
           isRoomManuallySelected = true;
           // æ–°è¦ä½œæˆå¾Œã€setã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å…ƒã«selectRoomã‚’å‘¼ã¶
           selectRoom({ id: roomId, type: "dm", members: newMembers, name: `DM with ${otherUsername}` });
       }).catch(error => { console.error("DM room creation failed:", error); alert("DMãƒ«ãƒ¼ãƒ ã®ä½œæˆå¤±æ•—: " + error.message); });
     } else {
       console.log("Existing DM room selected:", roomId);
       isRoomManuallySelected = true;
       selectRoom({ id: roomId, ...snapshot.val() }); // æ—¢å­˜ã®ãƒ«ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™
     }
   }).catch(error => { console.error("Error checking DM room:", error); alert("DMãƒ«ãƒ¼ãƒ ç¢ºèªã‚¨ãƒ©ãƒ¼: " + error.message); });
 }


 function handleSearchUserForGroup() { // ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ™‚ã®ãƒ¡ãƒ³ãƒãƒ¼æ¤œç´¢
   const keyword = searchUserForGroupInput.value.trim().toLowerCase();
   if (!groupMemberSearchResultsDiv || !currentUser) return;
   groupMemberSearchResultsDiv.innerHTML = "";
   if (!keyword) return;


   let usersFound = false;
   Object.entries(allRegisteredUsers).forEach(([uid, user]) => {
     if (selectedGroupMembers[uid] || !user.username_lower) return; // æ—¢ã«é¸æŠæ¸ˆã¿ã‹è‡ªåˆ†è‡ªèº«ã¯é™¤å¤–
     if (user.username_lower.includes(keyword)) {
         usersFound = true;
         const div = document.createElement("div");
         div.className = "searchUserItem";
         div.textContent = user.username;
         div.onclick = () => {
             addMemberToGroupSelection(uid, user.username);
             searchUserForGroupInput.value = "";
             groupMemberSearchResultsDiv.innerHTML = "";
         };
         groupMemberSearchResultsDiv.appendChild(div);
     }
   });
   if (!usersFound) groupMemberSearchResultsDiv.textContent = "è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã—";
 }


 function addMemberToGroupSelection(uid, username) {
   if (!selectedGroupMembers[uid]) {
     selectedGroupMembers[uid] = username;
     updateSelectedGroupMembersUI();
   }
 }
 function updateSelectedGroupMembersUI() {
   if (!selectedGroupMembersDiv || !currentUser) return;
   selectedGroupMembersDiv.innerHTML = "";
   Object.entries(selectedGroupMembers).forEach(([uid, username]) => {
       const span = document.createElement("span");
       span.className = "selectedMemberTag";
       span.dataset.uid = uid;
       span.textContent = username + (uid === currentUser.uid ? " (è‡ªåˆ†)" : "");
       if (uid !== currentUser.uid) {
           const removeBtn = document.createElement("button");
           removeBtn.textContent = "x"; removeBtn.type = "button";
           removeBtn.onclick = (e) => { e.stopPropagation(); removeMemberFromGroupSelection(uid); };
           span.appendChild(removeBtn);
       }
       selectedGroupMembersDiv.appendChild(span);
   });
 }
 function removeMemberFromGroupSelection(uid) {
   delete selectedGroupMembers[uid];
   updateSelectedGroupMembersUI();
 }


 async function handleCreateGroup() {
   if (!currentUser) return;
   const groupName = groupNameInput.value.trim();
   if (!groupName) { alert("ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
   const membersForDb = Object.keys(selectedGroupMembers).reduce((acc, uid) => { acc[uid] = true; return acc; }, {});
   if (Object.keys(membersForDb).length < 2) { alert("ã‚°ãƒ«ãƒ¼ãƒ—ã«ã¯è‡ªåˆ†ã‚’å«ã‚ã¦2äººä»¥ä¸Šå¿…è¦ã§ã™ã€‚"); return; }


   try {
     const newRoomRef = db.ref("rooms").push();
     const newRoomId = newRoomRef.key;
     const newGroupData = {
       type: "group", name: groupName, members: membersForDb,
       createdAt: firebase.database.ServerValue.TIMESTAMP, createdBy: currentUser.uid
     };
     await newRoomRef.set(newGroupData);
     alert(`ã‚°ãƒ«ãƒ¼ãƒ—ã€Œ${groupName}ã€ä½œæˆæˆåŠŸï¼`);
     groupNameInput.value = ""; searchUserForGroupInput.value = ""; groupMemberSearchResultsDiv.innerHTML = "";
     selectedGroupMembers = { [currentUser.uid]: currentUser.displayName || "åŒ¿å" }; // ãƒªã‚»ãƒƒãƒˆ
     updateSelectedGroupMembersUI();
     isRoomManuallySelected = true;
     selectRoom({ id: newRoomId, ...newGroupData }); // ä½œæˆã—ãŸã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠ
   } catch (e) { console.error("ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆã‚¨ãƒ©ãƒ¼:", e); alert("ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆå¤±æ•—: " + e.message); }
 }




 const emojis = ['ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜†','ğŸ˜…','ğŸ¤£','ğŸ˜‚','ğŸ™‚','ğŸ™ƒ','ğŸ˜‰','ğŸ˜Š','ğŸ˜‡','ğŸ¥°','ğŸ˜','ğŸ¤©','ğŸ˜˜','ğŸ˜—','ğŸ˜š','ğŸ˜™','ğŸ˜‹','ğŸ˜›','ğŸ˜œ','ğŸ¤ª','ğŸ˜','ğŸ¤‘','ğŸ¤—','ğŸ¤­','ğŸ¤«','ğŸ¤”','ğŸ¤','ğŸ¤¨','ğŸ˜','ğŸ˜‘','ğŸ˜¶','ğŸ˜','ğŸ˜’','ğŸ™„','ğŸ˜¬','ğŸ¤¥','ğŸ˜Œ','ğŸ˜”','ğŸ˜ª','ğŸ¤¤','ğŸ˜´','ğŸ˜·','ğŸ¤’','ğŸ¤•','ğŸ¤¢','ğŸ¤®','ğŸ¤§','ğŸ¥µ','ğŸ¥¶','ğŸ˜µ','ğŸ¤¯','ğŸ¤ ','ğŸ¥³','ğŸ˜','ğŸ¤“','ğŸ§','ğŸ˜•','ğŸ˜Ÿ','ğŸ™','ğŸ˜®','ğŸ˜¯','ğŸ˜²','ğŸ˜³','ğŸ¥º','ğŸ˜¦','ğŸ˜§','ğŸ˜¨','ğŸ˜°','ğŸ˜¥','ğŸ˜¢','ğŸ˜­','ğŸ˜±','ğŸ˜–','ğŸ˜£','ğŸ˜©','ğŸ˜«','ğŸ˜¤','ğŸ˜¡','ğŸ˜ ','ğŸ¤¬','ğŸ˜ˆ','ğŸ‘¿','ğŸ’€','ğŸ‘»','ğŸ‘½','ğŸ¤–'];
 function initEmojiPicker() {
   if (!emojiPicker) return;
   emojiPicker.innerHTML = ''; // åˆæœŸåŒ–æ™‚ã«ã‚¯ãƒªã‚¢
   emojis.forEach(emoji => {
     const button = document.createElement('button');
     button.type = 'button'; button.className = 'emoji-button'; button.textContent = emoji;
     button.onclick = () => {
       if (!messageInput) return;
       const start = messageInput.selectionStart; const end = messageInput.selectionEnd;
       messageInput.value = messageInput.value.substring(0, start) + emoji + messageInput.value.substring(end);
       messageInput.focus();
       messageInput.setSelectionRange(start + emoji.length, start + emoji.length);
     };
     emojiPicker.appendChild(button);
   });
 }
 function handleToggleEmojiPicker() {
   if (emojiPicker) emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'grid' : 'none';
 }


 async function handleUpdateProfile() {
     if (!editUsernameInput || !editIconColorInput || !editBioInput || !currentUser) return;
     const newUsername = editUsernameInput.value.trim();
     const newColor = editIconColorInput.value;
     const newBio = editBioInput.value.trim();
     if (!newUsername) { alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
     try {
         if (currentUser.displayName !== newUsername) {
           await currentUser.updateProfile({ displayName: newUsername });
         }
         await db.ref(`users/${currentUser.uid}`).update({
             username: newUsername, username_lower: newUsername.toLowerCase(),
             color: newColor, bio: newBio
         });
         alert("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°æˆåŠŸï¼");
     } catch (error) { console.error("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error); alert("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°å¤±æ•—: " + error.message); }
 }


 async function handleUpdateGroupProfile() { // ã‚°ãƒ«ãƒ¼ãƒ—åæ›´æ–°
     if (!currentRoomId || currentRoomType !== "group" || !editGroupNameInput) { alert("ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
     const newGroupName = editGroupNameInput.value.trim();
     if (!newGroupName) { alert("ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
     try {
         await db.ref(`rooms/${currentRoomId}`).update({ name: newGroupName });
         alert("ã‚°ãƒ«ãƒ¼ãƒ—åæ›´æ–°æˆåŠŸï¼");
         // rooms[currentRoomId] ã® name ã‚‚æ›´æ–°ã—ã¦ selectRoom ã‚’å‘¼ã¶
         if (rooms[currentRoomId]) {
           rooms[currentRoomId].name = newGroupName;
           selectRoom({ id: currentRoomId, ...rooms[currentRoomId] });
         }
     } catch (error) { console.error("ã‚°ãƒ«ãƒ¼ãƒ—åæ›´æ–°ã‚¨ãƒ©ãƒ¼:", error); alert("ã‚°ãƒ«ãƒ¼ãƒ—åæ›´æ–°å¤±æ•—: " + error.message); }
 }


 function handleSearchUserToAddGroupMember() { // ã‚°ãƒ«ãƒ¼ãƒ—ç·¨é›†æ™‚ã®ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ 
   const keyword = searchUserToAddGroupMemberInput.value.trim().toLowerCase();
   if (!groupMemberAddResultsDiv || !currentUser || !currentRoomData || currentRoomType !== 'group') return;
   groupMemberAddResultsDiv.innerHTML = "";
   if (!keyword) return;


   let usersFound = false;
   Object.entries(allRegisteredUsers).forEach(([uid, user]) => {
       if (currentRoomData.members[uid] || !user.username_lower) return; // æ—¢ã«ãƒ¡ãƒ³ãƒãƒ¼ã‹ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒãªã„å ´åˆã¯é™¤å¤–
       if (user.username_lower.includes(keyword)) {
           usersFound = true;
           const div = document.createElement("div");
           div.className = "searchUserItem"; div.textContent = user.username;
           div.onclick = async () => {
               if (confirm(`${user.username} ã‚’ã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`)) {
                   await addMemberToGroup(currentRoomId, uid);
                   searchUserToAddGroupMemberInput.value = ""; groupMemberAddResultsDiv.innerHTML = "";
               }
           };
           groupMemberAddResultsDiv.appendChild(div);
       }
   });
   if (!usersFound) groupMemberAddResultsDiv.textContent = "è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã—";
 }


 async function addMemberToGroup(roomId, uidToAdd) {
     try {
         await db.ref(`rooms/${roomId}/members/${uidToAdd}`).set(true);
         alert("ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ æˆåŠŸã€‚");
     } catch (error) { console.error("ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ ã‚¨ãƒ©ãƒ¼:", error); alert("ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ å¤±æ•—: " + error.message); }
 }


 function updateGroupMembersList(members) {
     if (!currentGroupMembersList || !currentUser || !allRegisteredUsers) return;
     currentGroupMembersList.innerHTML = '';
     const memberUids = Object.keys(members || {});
     memberUids.forEach(memberUid => {
         const memberInfo = allRegisteredUsers[memberUid];
         if (memberInfo) {
             const initial = memberInfo.username.charAt(0).toUpperCase();
             const color = memberInfo.color || getRandomColor();
             const listItem = document.createElement('li');
             listItem.className = 'group-member-item';
             listItem.innerHTML = `
                 <div style="display: flex; align-items: center;">
                     <div class="user-icon chat-user-icon" style="background-color: ${escapeHTML(color)};">${escapeHTML(initial)}</div>
                     <span>${escapeHTML(memberInfo.username)} ${memberUid === currentRoomData?.createdBy ? '(ä½œæˆè€…)' : ''} ${memberUid === currentUser.uid ? '(è‡ªåˆ†)' : ''}</span>
                 </div>`;
             // è‡ªåˆ†è‡ªèº«ã§ãªã„ã€ã‹ã¤ãƒ¡ãƒ³ãƒãƒ¼ãŒ2äººä»¥ä¸Šã„ã‚‹å ´åˆã®ã¿å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º (ä½œæˆè€…ã¯å‰Šé™¤ã§ããªã„ã‚ˆã†ã«ã™ã‚‹ã®ã‚‚ã‚ã‚Š)
             if (memberUid !== currentUser.uid && memberUids.length > 1 && memberUid !== currentRoomData?.createdBy) {
                 const removeBtn = document.createElement('button');
                 removeBtn.textContent = 'å‰Šé™¤'; removeBtn.type = 'button';
                 removeBtn.onclick = async () => {
                     if (confirm(`${memberInfo.username} ã‚’ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                         await removeMemberFromGroup(currentRoomId, memberUid);
                     }
                 };
                 listItem.appendChild(removeBtn);
             }
             currentGroupMembersList.appendChild(listItem);
         }
     });
 }


 async function removeMemberFromGroup(roomId, uidToRemove) {
     try {
         // ãƒ¡ãƒ³ãƒãƒ¼ãŒ1äººã—ã‹ã„ãªããªã‚‹å ´åˆã¯ãƒ«ãƒ¼ãƒ ã”ã¨å‰Šé™¤ã™ã‚‹ãªã©ã®è€ƒæ…®ã‚‚å¯èƒ½
         await db.ref(`rooms/${roomId}/members/${uidToRemove}`).remove();
         alert("ãƒ¡ãƒ³ãƒãƒ¼å‰Šé™¤æˆåŠŸã€‚");
         // currentRoomData.membersã‹ã‚‰ã‚‚å‰Šé™¤ã—ã€UIã‚’æ›´æ–°
         if (rooms[roomId] && rooms[roomId].members) {
           delete rooms[roomId].members[uidToRemove];
           selectRoom({id: roomId, ...rooms[roomId]}); // UIæ›´æ–°
         }
     } catch (error) { console.error("ãƒ¡ãƒ³ãƒãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error); alert("ãƒ¡ãƒ³ãƒãƒ¼å‰Šé™¤å¤±æ•—: " + error.message); }
 }


 async function handleRequestGroupDeletion() {
     if (!currentRoomId || currentRoomType !== "group" || !currentUser) { alert("ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆã‚’é¸æŠã€‚"); return; }
     if (!confirm("æœ¬å½“ã«ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã®å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ")) return;
     try {
         const deletionRef = db.ref(`rooms/${currentRoomId}/deletionRequest`);
         const snapshot = await deletionRef.once('value');
         if (snapshot.exists()) { alert("æ—¢ã«å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã™ã€‚"); return; }
         await deletionRef.set({
             requestedBy: currentUser.uid, requestedAt: firebase.database.ServerValue.TIMESTAMP,
             votes: { [currentUser.uid]: true }
         });
         alert("ã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹ã€‚ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã®è³›æˆãŒå¿…è¦ã§ã™ã€‚");
     } catch (error) { console.error("ã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:", error); alert("ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•—: " + error.message); }
 }


 let groupDeletionListener = null;
 function setupGroupDeletionListener(roomId) {
     if (!groupDeletionStatusDiv || !btnRequestGroupDeletion || !currentUser) return;
     const deletionRef = db.ref(`rooms/${roomId}/deletionRequest`);
    
     // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
     if (groupDeletionListener) {
         deletionRef.off('value', groupDeletionListener);
     }


     groupDeletionListener = async (snapshot) => { // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ä¿æŒ
         const deletionRequest = snapshot.val();
         groupDeletionStatusDiv.innerHTML = '';
         groupDeletionStatusDiv.style.display = 'none';
         btnRequestGroupDeletion.style.display = 'block';


         if (deletionRequest && currentRoomData && currentRoomData.members) { // currentRoomData.membersã®å­˜åœ¨ç¢ºèª
             groupDeletionStatusDiv.style.display = 'block';
             btnRequestGroupDeletion.style.display = 'none';


             const membersInRoom = Object.keys(currentRoomData.members).length;
             const votesCount = Object.keys(deletionRequest.votes || {}).length;
             // éåŠæ•°ã§ã¯ãªãã€å…¨å“¡ã®è³›æˆãŒå¿…è¦ãªä»•æ§˜ã«å¤‰æ›´ã™ã‚‹å ´åˆãªã©ã€æ¡ä»¶ã¯èª¿æ•´å¯èƒ½
             const requiredVotes = membersInRoom > 1 ? Math.floor(membersInRoom / 2) + 1 : 1; // 1äººã®å ´åˆã¯1ç¥¨ã§å¯


             let statusText = `ã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­: ${votesCount} / ${requiredVotes} ç¥¨`;


             if (votesCount >= requiredVotes) {
                 statusText += `<br><strong>å‰Šé™¤æ¡ä»¶æˆç«‹ï¼ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‰Šé™¤ã—ã¾ã™ã€‚</strong>`;
                 groupDeletionStatusDiv.innerHTML = statusText;
                 await deleteGroup(roomId);
             } else {
                 if (!deletionRequest.votes[currentUser.uid]) {
                     statusText += `<br><button id="btnVoteForDeletion" type="button">è³›æˆ</button> <button id="btnRejectDeletion" class="reject" type="button">åå¯¾</button>`;
                 } else {
                     statusText += `<br>ã‚ãªãŸã¯æ—¢ã«è³›æˆã—ã¦ã„ã¾ã™ã€‚`;
                 }
                 groupDeletionStatusDiv.innerHTML = statusText;


                 const btnVote = document.getElementById('btnVoteForDeletion');
                 const btnReject = document.getElementById('btnRejectDeletion');
                 if (btnVote) btnVote.onclick = async () => { db.ref(`rooms/${roomId}/deletionRequest/votes/${currentUser.uid}`).set(true); };
                 if (btnReject) btnReject.onclick = async () => { if (confirm("å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«åå¯¾ã—ã¾ã™ã‹ï¼Ÿãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå–ã‚Šæ¶ˆã•ã‚Œã¾ã™ã€‚")) { db.ref(`rooms/${roomId}/deletionRequest`).remove(); }};
             }
         }
     };
     deletionRef.on('value', groupDeletionListener, error => console.error("Deletion listener error:", error));
 }




 async function deleteGroup(roomIdToDelete) {
     try {
         await db.ref(`rooms/${roomIdToDelete}`).remove();
         alert("ã‚°ãƒ«ãƒ¼ãƒ—ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚");
         if (currentRoomId === roomIdToDelete) { // ç¾åœ¨è¡¨ç¤ºä¸­ã®ãƒ«ãƒ¼ãƒ ãŒå‰Šé™¤ã•ã‚ŒãŸå ´åˆ
             currentRoomId = null; currentRoomData = null; currentRoomType = null;
             clearChat();
             if (groupEditForm) groupEditForm.style.display = 'none';
             if (myProfileSection) myProfileSection.style.display = 'block';
             // isRoomManuallySelected = false; // è‡ªå‹•é¸æŠã‚’è¨±å¯ã™ã‚‹ãŸã‚ã«ãƒªã‚»ãƒƒãƒˆã‚‚æ¤œè¨
             // loadRooms(currentUser.uid); // ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã€ã‚‚ã—ã‚ã‚Œã°åˆ¥ã®ãƒ«ãƒ¼ãƒ ã‚’è‡ªå‹•é¸æŠ
         }
         // rooms ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã‚‚å‰Šé™¤
         delete rooms[roomIdToDelete];
         renderRoomList(); // ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’å†æç”»
     } catch (error) { console.error("ã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error); alert("ã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤å¤±æ•—: " + error.message); }
 }


 function clearRoomList() { if (roomListDiv) roomListDiv.innerHTML = ""; }
 function clearChat() {
   if (chatBox) chatBox.innerHTML = "ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„";
   if (roomTitle) roomTitle.textContent = "ãƒãƒ£ãƒƒãƒˆç”»é¢";
 }
 function clearProfile() { // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã«è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
   if (myProfileIcon) { myProfileIcon.innerHTML = ""; myProfileIcon.style.backgroundColor = ""; }
   if (myUsernameDisplay) myUsernameDisplay.textContent = "";
   if (myEmailDisplay) myEmailDisplay.textContent = "";
   if (myBioDisplay) myBioDisplay.textContent = "";
   if (editUsernameInput) editUsernameInput.value = "";
   if (editIconColorInput) editIconColorInput.value = "#000000";
   if (editBioInput) editBioInput.value = "";
 }


 function escapeHTML(str) {
   if (typeof str !== 'string') return '';
   return str.replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m]));
 }
 </script>


</body>
</html>


<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Firebase DMÂØæÂøú„ÉÅ„É£„ÉÉ„Éà„Ç¢„Éó„É™</title>
<style>
 body, html {
    height: 100%;
    margin: 0;
    font-family: sans-serif;
    }
 #app {
   display: flex;
   height: 100vh;
   }
 #leftPanel, #centerPanel, #rightPanel {
   background-color:#e7e7eb;
   padding: 10px;
   box-sizing: border-box;
   overflow-y: auto;
   }
 #leftPanel {
   color:white;
   flex: 1; width: 20%;
   border-right: 1px solid #ccc;
   background: #4c6473;
   }
 #centerPanel {
   color:white;
   background-color:#5c9291;
   flex: 2;
   width: 50%;
   border-right: 1px solid #eaf4fc;
   display: flex;
   flex-direction: column;
   }
 #rightPanel {
   background-color: #1f3134;
   color:white;
  flex: 1;
   width: 30%;
   }
   #myBioDisplay{
    color:white;
   }
 #chatBox {
   color:black;
   flex-grow: 1;
   border: 1px solid #ccc;
   padding: 5px;
   overflow-y: auto; background:#80aba9;
    }
 #messageForm {
   margin-top: 10px;
   display: flex;
   flex-wrap: wrap;
   gap: 10px;
   align-items: flex-end;
   }
 #messageInput {
   flex-grow: 1;
   padding: 5px;
   font-size: 16px;
   min-width: 100px;
   }
 button {
   display:flex;
   padding: 6px 12px;
   font-size: 16px;
   cursor: pointer;
   border: 1px solid white; background-color: #66cdaa; border-radius: 4px;
   color:white;
   }
 button:hover {
   background-color: #d0d0d0;
   }
 .roomItem {
   padding: 8px;
   border-bottom: 1px solid #ddd; cursor: pointer;
   display: flex;
   align-items: center; justify-content: space-between;
   }
 .roomItem.selected {
   background: #008899;
   }
 .room-list-icon {
   width: 25px;
   height: 25px;
   font-size: 0.9em;
   margin-right: 8px;
   border-radius: 50%;
   display: inline-flex;
   align-items: center; justify-content: center;
   color: white;
   text-transform: uppercase;
   flex-shrink: 0;
   }
 .unread-badge {
   background-color: #dc3545;
   color: white;
   font-size: 0.75em;
   padding: 2px 6px;
   border-radius: 12px;
   margin-left: 10px;
   min-width: 20px;
   text-align: center;
   }
 #searchResults {
  color:#43676b;
   max-height: 200px;
   overflow-y: auto;
   background: white;
   border: 1px solid #ccc; margin-bottom: 10px;
   margin-top: 5px;
   padding: 5px;
   }
 .searchUserItem {
   padding: 8px;
   border-bottom: 1px solid #eee; cursor: pointer;
   }
 .searchUserItem:last-child { border-bottom: none;
 }
 .searchUserItem:hover { background-color: #f0f0f0; }
 #loginForm {
   max-width: 300px;
   margin: 20px auto;
   padding: 20px;
   border: 1px solid #ccc; background: #f9f9f9; }
 #loginForm input[type="text"], #loginForm input[type="email"], #loginForm input[type="password"] {
   width: 100%;
   padding: 6px;
   margin: 6px 0 12px 0;
   box-sizing: border-box;
   }
 #groupCreationForm {
   padding: 10px;
   border: 1px solid #ccc;
   background-color: #53727d;
   margin-bottom: 15px;
   }
 #groupCreationForm input[type="text"] {
   width: calc(100% - 12px);
   padding: 5px;
   margin-bottom: 10px;
   }
 #selectedGroupMembers {
   border: 1px dashed #ccc;
   min-height: 30px;
   padding: 5px;
   margin-top: 5px;
   margin-bottom: 10px;
   }
 .selectedMemberTag {
   display: inline-block;
   background-color: #455765;
   padding: 3px 7px;
   margin: 3px;
   border-radius: 3px solid white;
   border: 1px soild white;
   font-size: 0.9em;
 }
 .selectedMemberTag button {
   background: none;
   border: none;
   color: #888;
   cursor: pointer;
   margin-left: 5px;
   padding: 0;
   font-size: 0.8em;
   }
 #btnLogout{
   background-color: #8f2e14;
 }
 .user-icon {
   width: 40px;
   height: 40px;
   border-radius: 50%;
   display: inline-flex;
   align-items: center;
   justify-content: center;
   font-size: 1.5em;
   font-weight: bold;
   color: white;
   text-transform: uppercase;
   margin-right: 10px;
   vertical-align: middle;
   flex-shrink: 0;
   border-radius: 3px soild white;
   }
 .chat-user-icon {
   width: 30px;
   height: 30px;
   font-size: 1.2em;
   margin-right: 5px;
   padding: 2px soild white;
    }
 .chat-message {
   display: flex;
   align-items: flex-start;
   margin-bottom: 10px;
   font-size: 1.0em
   }
 .message-content-wrapper { flex-grow: 1; }
 .message-header {
   display: flex;
   align-items: center;
   margin-bottom: 3px;
   color:white;
   font-size:0.5em;
   }
 .message-header span {
   font-size: 1.0em;
   color: white;
   margin-left: 5px;
   }
 .message-text {
   padding: 5px 10px;
   background-color: white;
   border-radius: 15px;
   display: inline-block;
   max-width: 80%;
   word-wrap: break-word;
   }
 #emojiPicker {
   display: grid;
   grid-template-columns: repeat(8, 1fr);
   gap: 5px; padding: 10px;
   border: 1px solid white;
   background: #fff; margin-top: 5px; margin-bottom: 10px; max-height: 150px; overflow-y: auto; display: none; width: 100%; box-sizing: border-box; }
 .emoji-button {
   font-size: 20px; background: none; border: none; cursor: pointer; padding: 2px; text-align: center;
   }
 .emoji-button:hover {
   background-color: #f0f0f0;
   }
 #toggleEmojiPicker { background-color: #f0f0f0; color: #333; font-size: 1.5em; line-height: 1; padding: 0 8px; }
 #toggleEmojiPicker:hover { background-color: #d0d0d0; }
 #profileEditForm { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
 #profileEditForm label { display: block; margin-bottom: 5px; font-weight: bold; }
 #profileEditForm input[type="text"], #profileEditForm input[type="color"], #profileEditForm textarea { width: calc(100% - 12px); padding: 5px; margin-bottom: 10px; box-sizing: border-box; }
 #profileEditForm textarea { resize: vertical; min-height: 60px; }
 #profileEditForm button { width: 100%; padding: 8px; background-color: #28a745; color: white; border: none; border-radius: 4px; }
 #profileEditForm button:hover { background-color: #218838; }
 #groupEditForm { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; display: none; }
 #groupEditForm label { display: block; margin-bottom: 5px; font-weight: bold; }
 #groupEditForm input[type="text"] { width: calc(100% - 12px); padding: 5px; margin-bottom: 10px; box-sizing: border-box; }
 #groupEditForm button { width: 100%; padding: 8px; background-color: #007bff; color: white; border: none; border-radius: 4px; margin-bottom: 5px; }
 #groupEditForm button:hover { background-color: #0056b3; }
 #btnRequestGroupDeletion { background-color: #dc3545; color: white; }
 #btnRequestGroupDeletion:hover { background-color: #c82333; }
 .group-member-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; padding: 5px; border: 1px solid #eee; border-radius: 4px; }
 .group-member-item button {
   background-color: #f0f0f0;
   color: #333;
   padding: 3px 8px;
   font-size: 0.8em;
   width: auto;
   }
 .group-member-item button:hover {
   background-color: #e0e0e0;
   }
 #groupMemberAddResults {
   max-height: 150px;
   overflow-y: auto;
   background: white;
   border: 1px solid #ccc;
   margin-bottom: 10px;
   margin-top: 5px;
   padding: 5px;
 }
 #groupDeletionStatus {
   margin-top: 10px;
   padding: 10px;
   border: 1px solid #ffc107;
   background-color: #fff3cd;
   color: #856404;
   border-radius: 4px;
   font-size: 0.9em;
   }
 #groupDeletionStatus button {
   margin-top: 5px;
   padding: 5px 10px;
   font-size: 0.9em;
   background-color: #007bff;
   color: white;
   }
 #groupDeletionStatus button.reject {
   background-color: #6c757d;
   }


#btnRequestGroupDeletion{
 color: #8f2e14;
}


</style>


<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>


</head>
<body>


<div id="loginScreen">
 <form id="loginForm" onsubmit="return false;">
   <h2>„É≠„Ç∞„Ç§„É≥„ÉªÊñ∞Ë¶èÁôªÈå≤</h2>
   <input type="text" id="regUsername" placeholder="„É¶„Éº„Ç∂„ÉºÂêçÔºàÁôªÈå≤ÊôÇ„ÅÆ„ÅøÔºâ" />
   <input type="email" id="email" placeholder="„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ" required />
   <input type="password" id="password" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" required />
   <button id="btnSignUp">ÁôªÈå≤</button>
   <button id="btnLogin">„É≠„Ç∞„Ç§„É≥</button>
 </form>
</div>


<div id="app" style="display:none;">
 <div id="leftPanel">
   <h3>Rooms</h3>
   <div id="groupCreationForm">
       <h4>„Ç∞„É´„Éº„Éó„Çí‰ΩúÊàê</h4>
       <input type="text" id="groupNameInput" placeholder="„Ç∞„É´„Éº„ÉóÂêç" />
       <input type="text" id="searchUserForGroupInput" placeholder="„É°„É≥„Éê„Éº„ÇíÊ§úÁ¥¢„Åó„Å¶ËøΩÂä†" style="width: calc(100% - 12px);" />
       <div id="groupMemberSearchResults"></div>
       <div id="selectedGroupMembers">
           <span class="selectedMemberTag" id="currentUserTag"></span>
       </div>
       <button id="btnCreateGroup">„Ç∞„É´„Éº„Éó‰ΩúÊàê</button>
   </div>
   <div>
     <input type="text" id="searchUserInput" placeholder="DM„Åó„Åü„ÅÑ„É¶„Éº„Ç∂„Éº„ÇíÊ§úÁ¥¢" style="width: calc(70% - 6px);" />
     <button id="btnSearchUser" style="width: calc(30% - 6px);">Ê§úÁ¥¢</button>
   </div>
   <div id="searchResults"></div>
   <h4 style="margin-top: 20px;">ChatRooms</h4>
   <div id="roomList"></div>
   <button id="btnLogout" style="margin-top: 20px; width: 100%;">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
 </div>


 <div id="centerPanel">
   <h3 id="roomTitle">Chat Box</h3>
   <div id="chatBox">„ÉÅ„É£„ÉÉ„Éà„É´„Éº„É†„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
   <form id="messageForm" onsubmit="handleSendMessage(); return false;">
     <button type="button" id="toggleEmojiPicker">üòÄ</button>
     <input type="text" id="messageInput" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ" autocomplete="off" />
     <button type="submit" id="btnSend">ÈÄÅ‰ø°</button>
     <div id="emojiPicker" style="width: 100%; order: -1;"></div>
   </form>
 </div>


 <div id="rightPanel">
   <h3>„Éó„É≠„Éï„Ç£„Éº„É´</h3>
   <div id="myProfileSection">
       <div id="profileContent">
           <div style="display: flex; align-items: center; margin-bottom: 10px;">
               <div id="myProfileIcon" class="user-icon"></div>
               <span id="myUsernameDisplay" style="font-size: 1.2em; font-weight: bold;"></span>
           </div>
           <p><strong>Email:</strong> <span id="myEmailDisplay"></span></p>
           <p><strong>Bio:</strong> <span id="myBioDisplay" style="white-space: pre-wrap; font-size: 0.9em; color: #white;"></span></p>
       </div>
       <div id="profileEditForm">
           <h4>„Éó„É≠„Éï„Ç£„Éº„É´„ÇíÁ∑®ÈõÜ</h4>
           <label for="editUsername">„É¶„Éº„Ç∂„ÉºÂêç:</label>
           <input type="text" id="editUsername" placeholder="Êñ∞„Åó„ÅÑ„É¶„Éº„Ç∂„ÉºÂêç" />
           <label for="editIconColor">„Ç¢„Ç§„Ç≥„É≥„Ç´„É©„Éº:</label>
           <input type="color" id="editIconColor" />
           <label for="editBio">bio:</label>
           <textarea id="editBio" placeholder="Ëá™Â∑±Á¥π‰ªãÊñá„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"></textarea>
           <button id="btnUpdateProfile">Êõ¥Êñ∞</button>
       </div>
   </div>
   <div id="groupEditForm">
       <h4>„Ç∞„É´„Éº„ÉóÊÉÖÂ†±„ÇíÁ∑®ÈõÜ</h4>
       <label for="editGroupName">„Ç∞„É´„Éº„ÉóÂêç:</label>
       <input type="text" id="editGroupName" placeholder="Êñ∞„Åó„ÅÑ„Ç∞„É´„Éº„ÉóÂêç" />
       <button id="btnUpdateGroupProfile">„Ç∞„É´„Éº„ÉóÊÉÖÂ†±Êõ¥Êñ∞</button>
       <h4 style="margin-top: 15px;">„É°„É≥„Éê„ÉºÁÆ°ÁêÜ</h4>
       <input type="text" id="searchUserToAddGroupMember" placeholder="„É°„É≥„Éê„Éº„ÇíËøΩÂä†" style="width: calc(100% - 12px);" />
       <div id="groupMemberAddResults"></div>
       <div style="margin-top: 10px;">
           <p><strong>ÁèæÂú®„ÅÆ„É°„É≥„Éê„Éº:</strong></p>
           <ul id="currentGroupMembers" style="list-style: none; padding: 0;"></ul>
       </div>
       <h4 style="margin-top: 15px;">„Ç∞„É´„Éº„ÉóÂâäÈô§</h4>
       <div id="groupDeletionStatus" style="display:none;"></div>
       <button id="btnRequestGroupDeletion">„Ç∞„É´„Éº„ÉóÂâäÈô§„É™„ÇØ„Ç®„Çπ„Éà</button>
   </div>
 </div>
</div>


<script>
 // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
 apiKey: "",
 authDomain: "",
 databaseURL: "",
 projectId: "",
 storageBucket: "",
 messagingSenderId: "",
 appId: "",
 measurementId: ""
}; 


 firebase.initializeApp(firebaseConfig);


 const auth = firebase.auth();
 const db = firebase.database();


 let loginScreen, app, inputUsername, inputEmail, inputPassword, btnSignUp, btnLogin;
 let roomListDiv, chatBox, roomTitle, profileContent, myProfileSection;
 let searchUserInput, searchResultsDiv, btnSearchUser, btnLogout, messageInput, btnSend;
 let groupNameInput, searchUserForGroupInput, groupMemberSearchResultsDiv, selectedGroupMembersDiv, currentUserTag, btnCreateGroup;
 let emojiPicker, toggleEmojiPickerBtn;
 let myProfileIcon, myUsernameDisplay, myEmailDisplay, myBioDisplay, editUsernameInput, editIconColorInput, editBioInput, btnUpdateProfile;
 let groupEditForm, editGroupNameInput, btnUpdateGroupProfile, searchUserToAddGroupMemberInput, groupMemberAddResultsDiv, currentGroupMembersList, btnRequestGroupDeletion, groupDeletionStatusDiv;


 let allRegisteredUsers = {};
 let selectedGroupMembers = {};


 let currentUser = null;
 let currentRoomId = null;
 let currentRoomData = null;
 let currentRoomType = null;
 let rooms = {};
 let currentRoomMessagesListener = null;
 let unreadCounts = {};
 let isRoomManuallySelected = false;
 let allUsersListener = null;
 let roomsListener = null;
 let unreadListener = null;




 document.addEventListener('DOMContentLoaded', () => {
   loginScreen = document.getElementById("loginScreen");
   app = document.getElementById("app");
   inputUsername = document.getElementById("regUsername");
   inputEmail = document.getElementById("email");
   inputPassword = document.getElementById("password");
   btnSignUp = document.getElementById("btnSignUp");
   btnLogin = document.getElementById("btnLogin");
   roomListDiv = document.getElementById("roomList");
   chatBox = document.getElementById("chatBox");
   roomTitle = document.getElementById("roomTitle");
   profileContent = document.getElementById("profileContent");
   myProfileSection = document.getElementById("myProfileSection");
   searchUserInput = document.getElementById("searchUserInput");
   searchResultsDiv = document.getElementById("searchResults");
   btnSearchUser = document.getElementById("btnSearchUser");
   btnLogout = document.getElementById("btnLogout");
   messageInput = document.getElementById("messageInput");
   btnSend = document.getElementById("btnSend");
   groupNameInput = document.getElementById("groupNameInput");
   searchUserForGroupInput = document.getElementById("searchUserForGroupInput");
   groupMemberSearchResultsDiv = document.getElementById("groupMemberSearchResults");
   selectedGroupMembersDiv = document.getElementById("selectedGroupMembers");
   currentUserTag = document.getElementById("currentUserTag");
   btnCreateGroup = document.getElementById("btnCreateGroup");
   emojiPicker = document.getElementById("emojiPicker");
   toggleEmojiPickerBtn = document.getElementById("toggleEmojiPicker");
   myProfileIcon = document.getElementById("myProfileIcon");
   myUsernameDisplay = document.getElementById("myUsernameDisplay");
   myEmailDisplay = document.getElementById("myEmailDisplay");
   myBioDisplay = document.getElementById("myBioDisplay");
   editUsernameInput = document.getElementById("editUsername");
   editIconColorInput = document.getElementById("editIconColor");
   editBioInput = document.getElementById("editBio");
   btnUpdateProfile = document.getElementById("btnUpdateProfile");
   groupEditForm = document.getElementById("groupEditForm");
   editGroupNameInput = document.getElementById("editGroupName");
   btnUpdateGroupProfile = document.getElementById("btnUpdateGroupProfile");
   searchUserToAddGroupMemberInput = document.getElementById("searchUserToAddGroupMember");
   groupMemberAddResultsDiv = document.getElementById("groupMemberAddResults");
   currentGroupMembersList = document.getElementById("currentGroupMembers");
   btnRequestGroupDeletion = document.getElementById("btnRequestGroupDeletion");
   groupDeletionStatusDiv = document.getElementById("groupDeletionStatus");


   setupEventListeners();
   initEmojiPicker();
 });


 function getRandomColor() {
     const letters = '0123456789ABCDEF';
     let color = '#';
     for (let i = 0; i < 6; i++) {
         color += letters[Math.floor(Math.random() * 16)];
     }
     return color;
 }


 function setupEventListeners() {
   btnSignUp.onclick = handleSignUp;
   btnLogin.onclick = handleLogin;
   btnLogout.onclick = handleLogout;
   // messageForm „ÅÆ onsubmit „Åß handleSendMessage „ÇíÂëº„Å∂„ÅÆ„Åß„ÄÅbtnSend.onclick „ÅØ‰∏çË¶Å
   // btnSend.onclick = handleSendMessage;
   btnSearchUser.onclick = handleSearchUser;
   searchUserInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSearchUser(); });
   searchUserForGroupInput.addEventListener('input', handleSearchUserForGroup); // „Ç∞„É´„Éº„Éó‰ΩúÊàêÊôÇ„ÅÆ„É°„É≥„Éê„ÉºÊ§úÁ¥¢
   btnCreateGroup.onclick = handleCreateGroup;
   toggleEmojiPickerBtn.onclick = handleToggleEmojiPicker;
   btnUpdateProfile.onclick = handleUpdateProfile;
   btnUpdateGroupProfile.onclick = handleUpdateGroupProfile;
   searchUserToAddGroupMemberInput.addEventListener('input', handleSearchUserToAddGroupMember); // „Ç∞„É´„Éº„ÉóÁ∑®ÈõÜÊôÇ„ÅÆ„É°„É≥„Éê„ÉºËøΩÂä†Ê§úÁ¥¢
   btnRequestGroupDeletion.onclick = handleRequestGroupDeletion;
 }


 async function handleSignUp() {
   const username = inputUsername.value.trim();
   const email = inputEmail.value.trim();
   const password = inputPassword.value.trim();
   if (!username) { alert("„É¶„Éº„Ç∂„ÉºÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÁôªÈå≤ÊôÇ„ÅÆ„ÅøÔºâ"); return; }
   if (!email || !password) { alert("„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); return; }
   try {
     const cred = await auth.createUserWithEmailAndPassword(email, password);
     await cred.user.updateProfile({ displayName: username });
     const initialColor = getRandomColor();
     await saveUserInfo(cred.user, initialColor, "");
     alert("ÁôªÈå≤ÊàêÂäüÔºÅ„É≠„Ç∞„Ç§„É≥Áä∂ÊÖã„Å´„Å™„Çä„Åæ„Åó„Åü„ÄÇ");
     inputUsername.value = ""; inputEmail.value = ""; inputPassword.value = "";
   } catch (e) { alert("ÁôªÈå≤„Ç®„É©„Éº: " + e.message); console.error("Signup error:", e); }
 }


 async function saveUserInfo(user, color = null, bio = null) {
     const userData = {
         username: user.displayName,
         username_lower: user.displayName.toLowerCase(),
         email: user.email,
     };
     if (color !== null) userData.color = color;
     if (bio !== null) userData.bio = bio;
     try {
       await db.ref("users/" + user.uid).update(userData);
     } catch (error) {
       console.error("Error saving user info:", error);
     }
 }


 async function handleLogin() {
   const email = inputEmail.value.trim();
   const password = inputPassword.value.trim();
   if (!email || !password) { alert("„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); return; }
   try {
     await auth.signInWithEmailAndPassword(email, password);
     inputEmail.value = ""; inputPassword.value = "";
   } catch (e) { alert("„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº: " + e.message); console.error("Login error:", e); }
 }


 async function handleLogout() {
   try {
     await auth.signOut();
   } catch (error) {
     console.error("Logout error:", error);
   }
 }


 auth.onAuthStateChanged(user => {
   console.log("Auth state changed. User:", user ? user.uid : "null");
   if (user) {
     currentUser = user;
     loginScreen.style.display = "none";
     app.style.display = "flex";
     if (currentUserTag) {
         currentUserTag.textContent = `${currentUser.displayName || "Ëá™ÂàÜ"}`;
         currentUserTag.dataset.uid = currentUser.uid;
     }
     if (roomTitle) roomTitle.textContent = "„ÉÅ„É£„ÉÉ„ÉàÁîªÈù¢";
     selectedGroupMembers = { [currentUser.uid]: currentUser.displayName || "ÂåøÂêç" };
     updateSelectedGroupMembersUI();


     loadAllUsersData(); // ÂÖ®„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÁõ£Ë¶ñÈñãÂßã


     db.ref("users/" + currentUser.uid).once("value").then(snapshot => {
         const userData = snapshot.val();
         let userColor = userData?.color;
         let userBio = userData?.bio === undefined ? "" : userData.bio; // bio„Ååundefined„Å™„ÇâÁ©∫ÊñáÂ≠óÂàó
         if (!userColor) {
             userColor = getRandomColor();
             db.ref("users/" + currentUser.uid).update({ color: userColor }).catch(e => console.error("Error saving initial color:", e));
         }
          if (userData?.bio === undefined) { // bio„ÅåÊú™ÂÆöÁæ©„Åß„ÅÇ„Çå„Å∞Á©∫ÊñáÂ≠óÂàó„Åß‰øùÂ≠ò
             db.ref("users/" + currentUser.uid).update({ bio: "" }).catch(e => console.error("Error saving initial bio:", e));
         }
         updateMyProfileDisplay(currentUser.displayName, userColor, userBio);
         if (editUsernameInput) editUsernameInput.value = currentUser.displayName || "";
         if (editIconColorInput) editIconColorInput.value = userColor;
         if (editBioInput) editBioInput.value = userBio;
     }).catch(error => {
         console.error("„É¶„Éº„Ç∂„Éº„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº:", error);
         const defaultColor = getRandomColor();
         updateMyProfileDisplay(currentUser.displayName, defaultColor, "");
         if (editUsernameInput) editUsernameInput.value = currentUser.displayName || "";
         if (editIconColorInput) editIconColorInput.value = defaultColor;
         if (editBioInput) editBioInput.value = "";
     });


     isRoomManuallySelected = false;
     loadRooms(user.uid); // „É´„Éº„É†„É™„Çπ„ÉàË™≠„ÅøËæº„Åø„Å®Áõ£Ë¶ñÈñãÂßã
     setupUnreadCountListener(); // Êú™Ë™≠Êï∞„É™„Çπ„Éä„ÉºË®≠ÂÆö„Å®Áõ£Ë¶ñÈñãÂßã


   } else {
     currentUser = null;
     loginScreen.style.display = "block";
     app.style.display = "none";
     clearRoomList(); clearChat(); clearProfile();
     if (searchResultsDiv) searchResultsDiv.innerHTML = "";
     allRegisteredUsers = {}; selectedGroupMembers = {};
     if (groupMemberSearchResultsDiv) groupMemberSearchResultsDiv.innerHTML = "";
     if (groupNameInput) groupNameInput.value = "";
     if (searchUserForGroupInput) searchUserForGroupInput.value = "";
     if (currentUserTag) currentUserTag.innerHTML = "";


     if (currentRoomMessagesListener) { // „É°„ÉÉ„Çª„Éº„Ç∏„É™„Çπ„Éä„ÉºËß£Èô§
         db.ref(`rooms/${currentRoomId}/messages`).off('child_added', currentRoomMessagesListener);
         currentRoomMessagesListener = null;
     }
     if (allUsersListener) { // ÂÖ®„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„É™„Çπ„Éä„ÉºËß£Èô§
       db.ref("users").off("value", allUsersListener);
       allUsersListener = null;
     }
     if (roomsListener) { // „É´„Éº„É†ÊÉÖÂ†±„É™„Çπ„Éä„ÉºËß£Èô§
       db.ref("rooms").off("value", roomsListener);
       roomsListener = null;
     }
     if (unreadListener) { // Êú™Ë™≠Êï∞„É™„Çπ„Éä„ÉºËß£Èô§
       db.ref("rooms").off("value", unreadListener); // setupUnreadCountListener „Åß rooms „ÇíÁõ£Ë¶ñ„Åó„Å¶„ÅÑ„Çã„ÅÆ„Åß
       unreadListener = null;
     }
      // „Ç∞„É´„Éº„ÉóÂâäÈô§„É™„Çπ„Éä„Éº„ÇÇËß£Èô§„Åó„Å¶„Åä„Åè (ÁâπÂÆö„ÅÆ„É´„Éº„É†ID„Å´Á¥ê„Å•„Åè„Åü„ÇÅ„ÄÅcurrentRoomId„Åånull„Å™„Çâ‰∏çË¶Å„Å†„ÅåÂøµ„ÅÆ„Åü„ÇÅ)
     if (currentRoomId) {
         db.ref(`rooms/${currentRoomId}/deletionRequest`).off();
     }




     unreadCounts = {}; isRoomManuallySelected = false;
     if (myProfileIcon) { myProfileIcon.innerHTML = ""; myProfileIcon.style.backgroundColor = ""; }
     if (myUsernameDisplay) myUsernameDisplay.textContent = "";
     if (myEmailDisplay) myEmailDisplay.textContent = "";
     if (myBioDisplay) myBioDisplay.textContent = "";
     if (editUsernameInput) editUsernameInput.value = "";
     if (editIconColorInput) editIconColorInput.value = "#000000";
     if (editBioInput) editBioInput.value = "";
     if (groupEditForm) groupEditForm.style.display = 'none';
     if (myProfileSection) myProfileSection.style.display = 'block';
     currentRoomId = null; currentRoomData = null; currentRoomType = null; rooms = {};
   }
 });


 function loadAllUsersData() {
   if (allUsersListener) db.ref("users").off("value", allUsersListener); // Âè§„ÅÑ„É™„Çπ„Éä„Éº„ÇíËß£Èô§
   allUsersListener = db.ref("users").on("value", snapshot => {
     allRegisteredUsers = snapshot.val() || {};
     renderRoomList(); // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÅåÂ§â„Çè„Çã„Å®DMÂêç„Å™„Å©„ÅåÂ§â„Çè„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„ÅÆ„ÅßÂÜçÊèèÁîª
     if (currentUser && allRegisteredUsers[currentUser.uid]) {
         const myData = allRegisteredUsers[currentUser.uid];
         updateMyProfileDisplay(myData.username, myData.color, myData.bio);
         if (editUsernameInput) editUsernameInput.value = myData.username;
         if (editIconColorInput) editIconColorInput.value = myData.color || getRandomColor();
         if (editBioInput) editBioInput.value = myData.bio || "";
     }
     if (currentRoomId && rooms[currentRoomId]) { // ÁèæÂú®„ÅÆ„É´„Éº„É†Ë°®Á§∫„ÇÇÊõ¥Êñ∞
         selectRoom({ id: currentRoomId, ...rooms[currentRoomId] });
     }
   }, error => console.error("Error loading all users data:", error));
 }


 function updateMyProfileDisplay(username, color, bio) {
     if (myProfileIcon) {
         if (username) {
             myProfileIcon.textContent = username.charAt(0).toUpperCase();
             myProfileIcon.style.backgroundColor = color || getRandomColor();
         } else {
             myProfileIcon.textContent = ""; myProfileIcon.style.backgroundColor = "";
         }
     }
     if (myUsernameDisplay) myUsernameDisplay.textContent = username || "";
     if (myEmailDisplay && currentUser) myEmailDisplay.textContent = currentUser.email || "";
     if (myBioDisplay) myBioDisplay.textContent = bio || "";
 }


 function loadRooms(uid) {
   const roomsQuery = db.ref("rooms").orderByChild(`members/${uid}`).equalTo(true);
   if (roomsListener) db.ref("rooms").off("value", roomsListener); // roomsRef„ÅØÂ∫É„Åô„Åé„Çã„ÅÆ„Åß„ÇØ„Ç®„É™„Å´ÂØæ„Åó„Å¶off„Åß„Åç„Å™„ÅÑ„ÄÇ‰∏ÄÊó¶ÂÖ®Ëß£Èô§„ÄÇ


   roomsListener = roomsQuery.on("value", snapshot => {
     console.log("loadRooms: roomsRef onValue triggered. currentRoomId:", currentRoomId, "isRoomManuallySelected:", isRoomManuallySelected);
     rooms = snapshot.val() || {};
     renderRoomList();


     if (currentRoomId && !rooms[currentRoomId]) {
         console.log("loadRooms: Current room was deleted, clearing selection.");
         currentRoomId = null; currentRoomData = null; currentRoomType = null;
         clearChat();
         // clearProfile(); // Ëá™ÂàÜ„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´„ÅØÊÆã„Åô
         if (groupEditForm) groupEditForm.style.display = 'none';
         if (myProfileSection) myProfileSection.style.display = 'block';
         isRoomManuallySelected = false;
     } else if (currentRoomId && rooms[currentRoomId]) {
         // ÈÅ∏Êäû‰∏≠„ÅÆ„É´„Éº„É†„Éá„Éº„Çø„ÅåÊõ¥Êñ∞„Åï„Çå„ÅüÂ†¥Âêà„ÄÅÂÜçÈÅ∏Êäû„Åó„Å¶UIÊõ¥Êñ∞
         selectRoom({ id: currentRoomId, ...rooms[currentRoomId] });
     } else if (!currentRoomId && Object.keys(rooms).length > 0 && !isRoomManuallySelected) {
         const firstRoomId = Object.keys(rooms)[0];
         console.log("loadRooms: Automatically selecting first room:", firstRoomId);
         selectRoom({ id: firstRoomId, ...rooms[firstRoomId] });
     }
   }, error => console.error("Error loading rooms:", error));
 }


 function setupUnreadCountListener() {
     if (unreadListener) db.ref("rooms").off("value", unreadListener); // Âè§„ÅÑ„É™„Çπ„Éä„Éº„ÇíËß£Èô§


     unreadListener = db.ref("rooms").on("value", async (snapshot) => {
         if (!currentUser) return;
         const allRoomsData = snapshot.val() || {};
         const newUnreadCounts = {};
         const unreadPromises = [];


         for (const roomId in allRoomsData) {
             const room = allRoomsData[roomId];
             if (!room.members || !room.members[currentUser.uid]) continue;


             const lastReadTimestamp = room.lastRead?.[currentUser.uid] || 0;
             const messagesRef = db.ref(`rooms/${roomId}/messages`);


             unreadPromises.push(
                 messagesRef.orderByChild('timestamp').startAt(lastReadTimestamp + 1).once('value')
                     .then(messagesSnapshot => {
                         let unreadCount = 0;
                         messagesSnapshot.forEach(messageChild => {
                             if (messageChild.val().uid !== currentUser.uid) unreadCount++;
                         });
                         newUnreadCounts[roomId] = unreadCount;
                     }).catch(e => console.error(`Error counting unread for ${roomId}:`, e))
             );
         }
         try {
           await Promise.all(unreadPromises);
           unreadCounts = newUnreadCounts;
           renderRoomList();
         } catch (error) {
           console.error("Error calculating unread counts:", error);
         }
     }, error => console.error("Error in unread count listener:", error));
 }




 function renderRoomList() {
   if (!roomListDiv || !currentUser) return;
   roomListDiv.innerHTML = "";
   Object.entries(rooms).sort(([,a], [,b]) => { // createdAt„Åß„ÇΩ„Éº„ÉàÔºàÊñ∞„Åó„ÅÑ„ÇÇ„ÅÆ„Åå‰∏äÔºâ„ÇÇÊ§úË®é„Åß„Åç„Çã
       const timeA = Object.values(a.messages || {}).sort((x,y) => y.timestamp - x.timestamp)[0]?.timestamp || a.createdAt || 0;
       const timeB = Object.values(b.messages || {}).sort((x,y) => y.timestamp - x.timestamp)[0]?.timestamp || b.createdAt || 0;
       return timeB - timeA;
   }).forEach(([roomId, room]) => {
     if (!room.members || !room.members[currentUser.uid]) return;


     let roomDisplayName, roomIconHtml;
     const roomTypeToDisplay = room.type || (roomId.startsWith("dm_") ? "dm" : "group");


     if (roomTypeToDisplay === "dm") {
         const otherUid = Object.keys(room.members).find(uid => uid !== currentUser.uid);
         const otherUser = allRegisteredUsers[otherUid];
         if (!otherUser) { console.warn(`renderRoomList: Skipping DM room ${roomId}, other user ${otherUid} not found.`); return; }
         roomDisplayName = otherUser.username;
         const initial = otherUser.username.charAt(0).toUpperCase();
         const color = otherUser.color || getRandomColor();
         roomIconHtml = `<div class="user-icon room-list-icon" style="background-color: ${escapeHTML(color)};">${escapeHTML(initial)}</div>`;
     } else { // group or unknown (defaults to group icon)
         roomDisplayName = room.name || "ÂêçÁß∞Êú™Ë®≠ÂÆö„Ç∞„É´„Éº„Éó";
         const groupInitial = room.name ? room.name.charAt(0).toUpperCase() : 'G';
         const groupColor = room.iconColor || '#007bff'; // „Ç∞„É´„Éº„Éó„Å´„ÇÇ„Ç¢„Ç§„Ç≥„É≥Ëâ≤„ÇíÊåÅ„Åü„Åõ„Çã„Å™„Çâ
         roomIconHtml = `<div class="user-icon room-list-icon" style="background-color: ${escapeHTML(groupColor)};">${escapeHTML(groupInitial)}</div>`;
     }


     const div = document.createElement("div");
     div.className = "roomItem" + (roomId === currentRoomId ? " selected" : "");
     div.dataset.roomId = roomId;
     const unread = unreadCounts[roomId] || 0;
     const unreadBadgeHtml = unread > 0 ? `<span class="unread-badge">${unread}</span>` : '';
     div.innerHTML = `<div style="display: flex; align-items: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-grow: 1;">${roomIconHtml}<span style="overflow: hidden; text-overflow: ellipsis;">${escapeHTML(roomDisplayName)}</span></div> ${unreadBadgeHtml}`;
     div.onclick = () => {
         isRoomManuallySelected = true;
         selectRoom({ id: roomId, ...room });
     };
     roomListDiv.appendChild(div);
   });
 }


 let messageListenerCallback = null; // „Ç≥„Éº„É´„Éê„ÉÉ„ÇØ„Çí‰øùÊåÅ„Åó„Å¶Ëß£Èô§„Åß„Åç„Çã„Çà„ÅÜ„Å´„Åô„Çã


 function selectRoom(room) {
   console.groupCollapsed("selectRoom called for room:", room.id);
   console.log("Full room object:", room);
   const newRoomId = room.id;
   let determinedRoomType = room.type || (newRoomId.startsWith("dm_") ? "dm" : "group");
   currentRoomType = determinedRoomType; // „Ç∞„É≠„Éº„Éê„É´Êõ¥Êñ∞


   if (!room.members) {
       console.error(`selectRoom: Room ${newRoomId} has no 'members' field.`);
       console.groupEnd();
       return;
   }


   // Êó¢Â≠ò„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„É™„Çπ„Éä„Éº„ÇíËß£Èô§
   if (currentRoomMessagesListener && messageListenerCallback) {
       console.log("Detaching old message listener for room:", currentRoomId);
       db.ref(`rooms/${currentRoomId}/messages`).off('child_added', messageListenerCallback);
       currentRoomMessagesListener = null;
       messageListenerCallback = null;
   }
   // Êó¢Â≠ò„ÅÆ„Ç∞„É´„Éº„ÉóÂâäÈô§„É™„Çπ„Éä„Éº„ÇíËß£Èô§
   if (currentRoomId && groupDeletionStatusDiv) { // currentRoomId „Åå null „Åß„Å™„ÅÑ„Åì„Å®„ÇíÁ¢∫Ë™ç
       db.ref(`rooms/${currentRoomId}/deletionRequest`).off();
   }




   if (chatBox) chatBox.innerHTML = "„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË™≠„ÅøËæº„Åø‰∏≠..."; // ÂàùÊúüË°®Á§∫


   currentRoomId = newRoomId;
   currentRoomData = room; // roomÂÖ®‰Ωì„Çí‰øùÂ≠ò


   document.querySelectorAll('.roomItem').forEach(item => item.classList.remove('selected'));
   const selectedRoomElement = Array.from(roomListDiv.children).find(el => el.dataset.roomId === newRoomId);
   if (selectedRoomElement) selectedRoomElement.classList.add('selected');


   updateRoomTitle(room);


   if (currentRoomType === "group") {
       if (myProfileSection) myProfileSection.style.display = 'none';
       if (groupEditForm) groupEditForm.style.display = 'block';
       if (editGroupNameInput) editGroupNameInput.value = room.name || "";
       updateGroupMembersList(room.members);
       setupGroupDeletionListener(newRoomId); // Êñ∞„Åó„ÅÑ„É´„Éº„É†ID„Åß„É™„Çπ„Éä„ÉºË®≠ÂÆö
   } else { // DM
       if (myProfileSection) myProfileSection.style.display = 'block';
       if (groupEditForm) groupEditForm.style.display = 'none';
       const otherUid = Object.keys(room.members).find(uid => uid !== currentUser.uid);
       const otherUser = allRegisteredUsers[otherUid];
       updateDMProfilePanel(otherUser);
   }


   // ÊúÄÁµÇÊó¢Ë™≠„ÇíÊõ¥Êñ∞ („É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÅÇ„Çå„Å∞„Åù„ÅÆÊúÄÊñ∞„ÄÅ„Å™„Åë„Çå„Å∞ÁèæÂú®ÊôÇÂàª)
   db.ref(`rooms/${newRoomId}/messages`).orderByChild('timestamp').limitToLast(1).once('value', snapshot => {
       let lastTimestamp = firebase.database.ServerValue.TIMESTAMP;
       if (snapshot.exists()) {
           const lastMessage = Object.values(snapshot.val())[0];
           if (lastMessage) lastTimestamp = lastMessage.timestamp;
       }
       if (currentUser) {
            db.ref(`rooms/${newRoomId}/lastRead/${currentUser.uid}`).set(lastTimestamp)
               .catch(e => console.error("Error updating last read:", e));
       }
   });




   const messagesRef = db.ref(`rooms/${newRoomId}/messages`);
   chatBox.innerHTML = ""; // „É°„ÉÉ„Çª„Éº„Ç∏„É≠„Éº„ÉâÂâç„Å´‰∏ÄÊó¶„ÇØ„É™„Ç¢


   // ÈÅéÂéª„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË™≠„ÅøËæº„Åø (ÊúÄÂ§ß100‰ª∂)
   messagesRef.orderByChild('timestamp').limitToLast(100).once('value', snapshot => {
       if (!snapshot.exists() || snapshot.numChildren() === 0) {
           if (chatBox) chatBox.textContent = "„Åì„ÅÆ„ÉÅ„É£„ÉÉ„Éà„É´„Éº„É†„Å´„ÅØ„Åæ„Å†„É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ";
       } else {
           if (chatBox) chatBox.innerHTML = ""; // Âøµ„ÅÆ„Åü„ÇÅÂÜçÂ∫¶„ÇØ„É™„Ç¢
           snapshot.forEach(childSnapshot => {
               appendMessageToChatbox(childSnapshot.key, childSnapshot.val());
           });
           if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
       }


       // Êñ∞„Åó„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
       // Âè§„ÅÑ„É™„Çπ„Éä„Éº„ÅØÊó¢„Å´Ëß£Èô§„Åï„Çå„Å¶„ÅÑ„Çã„ÅØ„Åö
       if (messageListenerCallback) { // ‰∫åÈáçÁôªÈå≤Èò≤Ê≠¢
           messagesRef.off('child_added', messageListenerCallback);
       }
       messageListenerCallback = (msgSnapshot) => { // „Ç≥„Éº„É´„Éê„ÉÉ„ÇØ„Çí‰øùÊåÅ
           // Êó¢„Å´Ë°®Á§∫„Åï„Çå„Å¶„ÅÑ„Çã„É°„ÉÉ„Çª„Éº„Ç∏„ÅØËøΩÂä†„Åó„Å™„ÅÑ (once„Åß„É≠„Éº„Éâ„Åï„Çå„Åü„ÇÇ„ÅÆ„Å®„ÅÆÈáçË§áÂõûÈÅø)
           if (chatBox.querySelector(`[data-message-id="${msgSnapshot.key}"]`)) return;
          
           if (chatBox.textContent === "„Åì„ÅÆ„ÉÅ„É£„ÉÉ„Éà„É´„Éº„É†„Å´„ÅØ„Åæ„Å†„É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ") {
                if (chatBox) chatBox.innerHTML = "";
           }
           appendMessageToChatbox(msgSnapshot.key, msgSnapshot.val());
           if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;


           if (currentUser && msgSnapshot.val().uid !== currentUser.uid) {
               db.ref(`rooms/${newRoomId}/lastRead/${currentUser.uid}`).set(msgSnapshot.val().timestamp)
                   .catch(e => console.error("Error updating last read on new message:", e));
           }
       };
       currentRoomMessagesListener = messagesRef.orderByChild('timestamp').startAt(Date.now()) // ÂàùÂõû„É≠„Éº„ÉâÂæå„ÅØÊñ∞„Åó„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ„ÅøÂèñÂæó„Åô„ÇãÂ∑•Â§´
                                            .on('child_added', messageListenerCallback, error => {
           console.error("Error in message listener for room", newRoomId, ":", error);
           if (chatBox) chatBox.textContent = "„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂèó‰ø°‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ";
       });


   }, (error) => {
       console.error("Error loading initial messages for room", newRoomId, ":", error);
       if (chatBox) chatBox.textContent = "„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆË™≠„ÅøËæº„Åø‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ";
   });
   console.groupEnd();
 }


 function appendMessageToChatbox(messageId, data) {
     if (!chatBox || !currentUser) return;
     const div = document.createElement("div");
     div.className = "chat-message";
     div.dataset.messageId = messageId;
     const timestamp = data.timestamp ? new Date(data.timestamp).toLocaleString() : '‰∏çÊòé„Å™ÊôÇÈñì';
     const senderInfo = allRegisteredUsers[data.uid];
     const senderUsername = senderInfo?.username || data.username || "‰∏çÊòé„Å™„É¶„Éº„Ç∂„Éº";
     const senderColor = senderInfo?.color || getRandomColor();
     const senderInitial = senderUsername.charAt(0).toUpperCase();


     div.innerHTML = `
       <div class="user-icon chat-user-icon" style="background-color: ${escapeHTML(senderColor)};" title="${escapeHTML(senderUsername)}">${escapeHTML(senderInitial)}</div>
       <div class="message-content-wrapper">
           <div class="message-header">
               <span>${escapeHTML(senderUsername)}</span> @ ${timestamp}
           </div>
           <div class="message-text">${escapeHTML(data.message)}</div>
       </div>`;
     chatBox.appendChild(div);
 }




 function updateDMProfilePanel(otherUser) {
     if (!profileContent || !myProfileSection) return;
     myProfileSection.style.display = 'block'; // Ëá™ÂàÜ„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
     if (!otherUser) {
         profileContent.innerHTML = `<h4>Áõ∏ÊâãÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</h4><p>„Åì„ÅÆDM„ÅÆÁõ∏Êâã„É¶„Éº„Ç∂„Éº„ÅØÂ≠òÂú®„Åó„Å™„ÅÑ„Åã„ÄÅ„Éá„Éº„Çø„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</p>`;
     } else {
         // DMÁõ∏Êâã„ÅÆÊÉÖÂ†±„ÇíË°®Á§∫„Åô„Çã„ÅÆ„Åß„ÅØ„Å™„Åè„ÄÅÂ∏∏„Å´Ëá™ÂàÜ„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´„ÇíË°®Á§∫„Åó„ÄÅ„Ç∞„É´„Éº„ÉóÁ∑®ÈõÜ„Éï„Ç©„Éº„É†„ÇíÈö†„Åô
         // Âè≥„Éë„Éç„É´„ÅØÂ∏∏„Å´„ÄåËá™ÂàÜ„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´„Äç„Åæ„Åü„ÅØ„Äå„Ç∞„É´„Éº„ÉóÁ∑®ÈõÜ„Äç„ÅÆ„Å©„Å°„Çâ„Åã„Å™„ÅÆ„Åß„ÄÅDMÈÅ∏ÊäûÊôÇ„ÅØ„ÄåËá™ÂàÜ„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´„Äç
         // updateMyProfileDisplay „ÅßËá™ÂàÜ„ÅÆÊÉÖÂ†±„ÅØÊõ¥Êñ∞Ê∏à„Åø„ÅÆ„ÅØ„Åö
         if (groupEditForm) groupEditForm.style.display = 'none'; // „Ç∞„É´„Éº„ÉóÁ∑®ÈõÜ„Éï„Ç©„Éº„É†„ÇíÈö†„Åô
     }
 }




 function updateRoomTitle(room) {
     if (!roomTitle || !currentUser) return;
     let displayRoomName = room.name;
     const determinedRoomType = room.type || (room.id.startsWith("dm_") ? "dm" : "group");


     if (determinedRoomType === "dm") {
         const otherUid = Object.keys(room.members || {}).find(uid => uid !== currentUser.uid);
         const otherUser = allRegisteredUsers[otherUid];
         displayRoomName = `DM: ${otherUser ? otherUser.username : (room.name || "Áõ∏Êâã‰∏çÊòé")}`;
     } else if (determinedRoomType === "group") {
         displayRoomName = `„Ç∞„É´„Éº„Éó: ${room.name || "ÂêçÁß∞Êú™Ë®≠ÂÆö„Ç∞„É´„Éº„Éó"}`;
     } else {
         displayRoomName = room.name || "„ÉÅ„É£„ÉÉ„Éà";
     }
     roomTitle.textContent = displayRoomName;
 }


 function handleSendMessage() {
    const msg = messageInput.value.trim();
    if (!msg || !currentUser) return;
    sendMessage(msg);
    messageInput.value = "";
    if (emojiPicker.style.display === 'grid') { // ÈÄÅ‰ø°ÂæåÁµµÊñáÂ≠ó„Éî„ÉÉ„Ç´„Éº„ÇíÈñâ„Åò„Çã
       emojiPicker.style.display = 'none';
    }
 }


 function sendMessage(text) {
   if (!currentRoomId) { console.error("sendMessage: currentRoomId is null."); alert("„ÉÅ„É£„ÉÉ„Éà„É´„Éº„É†„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ"); return; }
   if (!currentUser) { console.error("sendMessage: currentUser is null."); return; }
   console.log(`sendMessage: Room ${currentRoomId}, User ${currentUser.uid}, Message: ${text}`);
   db.ref(`rooms/${currentRoomId}/messages`).push({
     username: currentUser.displayName || "ÂåøÂêç",
     uid: currentUser.uid,
     message: text,
     timestamp: firebase.database.ServerValue.TIMESTAMP
   }).then(() => {
       console.log("Message sent successfully to room:", currentRoomId);
   }).catch(error => {
       console.error("Message sending error:", error);
       alert("„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: " + error.message);
   });
 }


 function handleSearchUser() {
   const keyword = searchUserInput.value.trim().toLowerCase();
   if (!searchResultsDiv) return;
   searchResultsDiv.innerHTML = "";
   if (!keyword) return;


   let usersFound = false;
   Object.entries(allRegisteredUsers).forEach(([uid, user]) => {
     if (uid === currentUser.uid || !user.username_lower) return;
     if (user.username_lower.includes(keyword)) {
         usersFound = true;
         const div = document.createElement("div");
         div.className = "searchUserItem";
         div.textContent = user.username;
         div.onclick = () => {
             createOrSelectDMRoom(uid, user.username);
             if (searchUserInput) searchUserInput.value = "";
             if (searchResultsDiv) searchResultsDiv.innerHTML = "";
         };
         searchResultsDiv.appendChild(div);
     }
   });
   if (!usersFound) searchResultsDiv.textContent = "Ë©≤ÂΩì„Åô„Çã„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ";
 }


 function createOrSelectDMRoom(otherUserId, otherUsername) {
   if (!currentUser) return;
   const currentUserId = currentUser.uid;
   const roomId = currentUserId < otherUserId ? `dm_${currentUserId}_${otherUserId}` : `dm_${otherUserId}_${currentUserId}`;
   const roomRef = db.ref("rooms/" + roomId);


   roomRef.once("value").then(snapshot => {
     if (!snapshot.exists()) {
       const newMembers = {};
       newMembers[currentUserId] = true;
       newMembers[otherUserId] = true;
       roomRef.set({
         type: "dm",
         members: newMembers,
         name: `DM with ${otherUsername}`, // DM„É´„Éº„É†Âêç„ÇÇ‰∏ÄÂøúË®≠ÂÆö
         createdAt: firebase.database.ServerValue.TIMESTAMP,
         createdBy: currentUserId
       }).then(() => {
           console.log("New DM room created:", roomId);
           isRoomManuallySelected = true;
           // Êñ∞Ë¶è‰ΩúÊàêÂæå„ÄÅset„Åó„Åü„Éá„Éº„Çø„ÇíÂÖÉ„Å´selectRoom„ÇíÂëº„Å∂
           selectRoom({ id: roomId, type: "dm", members: newMembers, name: `DM with ${otherUsername}` });
       }).catch(error => { console.error("DM room creation failed:", error); alert("DM„É´„Éº„É†„ÅÆ‰ΩúÊàêÂ§±Êïó: " + error.message); });
     } else {
       console.log("Existing DM room selected:", roomId);
       isRoomManuallySelected = true;
       selectRoom({ id: roomId, ...snapshot.val() }); // Êó¢Â≠ò„ÅÆ„É´„Éº„É†„Éá„Éº„Çø„ÇíÊ∏°„Åô
     }
   }).catch(error => { console.error("Error checking DM room:", error); alert("DM„É´„Éº„É†Á¢∫Ë™ç„Ç®„É©„Éº: " + error.message); });
 }


 function handleSearchUserForGroup() { // „Ç∞„É´„Éº„Éó‰ΩúÊàêÊôÇ„ÅÆ„É°„É≥„Éê„ÉºÊ§úÁ¥¢
   const keyword = searchUserForGroupInput.value.trim().toLowerCase();
   if (!groupMemberSearchResultsDiv || !currentUser) return;
   groupMemberSearchResultsDiv.innerHTML = "";
   if (!keyword) return;


   let usersFound = false;
   Object.entries(allRegisteredUsers).forEach(([uid, user]) => {
     if (selectedGroupMembers[uid] || !user.username_lower) return; // Êó¢„Å´ÈÅ∏ÊäûÊ∏à„Åø„ÅãËá™ÂàÜËá™Ë∫´„ÅØÈô§Â§ñ
     if (user.username_lower.includes(keyword)) {
         usersFound = true;
         const div = document.createElement("div");
         div.className = "searchUserItem";
         div.textContent = user.username;
         div.onclick = () => {
             addMemberToGroupSelection(uid, user.username);
             searchUserForGroupInput.value = "";
             groupMemberSearchResultsDiv.innerHTML = "";
         };
         groupMemberSearchResultsDiv.appendChild(div);
     }
   });
   if (!usersFound) groupMemberSearchResultsDiv.textContent = "Ë©≤ÂΩì„É¶„Éº„Ç∂„Éº„Å™„Åó";
 }


 function addMemberToGroupSelection(uid, username) {
   if (!selectedGroupMembers[uid]) {
     selectedGroupMembers[uid] = username;
     updateSelectedGroupMembersUI();
   }
 }
 function updateSelectedGroupMembersUI() {
   if (!selectedGroupMembersDiv || !currentUser) return;
   selectedGroupMembersDiv.innerHTML = "";
   Object.entries(selectedGroupMembers).forEach(([uid, username]) => {
       const span = document.createElement("span");
       span.className = "selectedMemberTag";
       span.dataset.uid = uid;
       span.textContent = username + (uid === currentUser.uid ? " (Ëá™ÂàÜ)" : "");
       if (uid !== currentUser.uid) {
           const removeBtn = document.createElement("button");
           removeBtn.textContent = "x"; removeBtn.type = "button";
           removeBtn.onclick = (e) => { e.stopPropagation(); removeMemberFromGroupSelection(uid); };
           span.appendChild(removeBtn);
       }
       selectedGroupMembersDiv.appendChild(span);
   });
 }
 function removeMemberFromGroupSelection(uid) {
   delete selectedGroupMembers[uid];
   updateSelectedGroupMembersUI();
 }


 async function handleCreateGroup() {
   if (!currentUser) return;
   const groupName = groupNameInput.value.trim();
   if (!groupName) { alert("„Ç∞„É´„Éº„ÉóÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"); return; }
   const membersForDb = Object.keys(selectedGroupMembers).reduce((acc, uid) => { acc[uid] = true; return acc; }, {});
   if (Object.keys(membersForDb).length < 2) { alert("„Ç∞„É´„Éº„Éó„Å´„ÅØËá™ÂàÜ„ÇíÂê´„ÇÅ„Å¶2‰∫∫‰ª•‰∏äÂøÖË¶Å„Åß„Åô„ÄÇ"); return; }


   try {
     const newRoomRef = db.ref("rooms").push();
     const newRoomId = newRoomRef.key;
     const newGroupData = {
       type: "group", name: groupName, members: membersForDb,
       createdAt: firebase.database.ServerValue.TIMESTAMP, createdBy: currentUser.uid
     };
     await newRoomRef.set(newGroupData);
     alert(`„Ç∞„É´„Éº„Éó„Äå${groupName}„Äç‰ΩúÊàêÊàêÂäüÔºÅ`);
     groupNameInput.value = ""; searchUserForGroupInput.value = ""; groupMemberSearchResultsDiv.innerHTML = "";
     selectedGroupMembers = { [currentUser.uid]: currentUser.displayName || "ÂåøÂêç" }; // „É™„Çª„ÉÉ„Éà
     updateSelectedGroupMembersUI();
     isRoomManuallySelected = true;
     selectRoom({ id: newRoomId, ...newGroupData }); // ‰ΩúÊàê„Åó„Åü„Ç∞„É´„Éº„Éó„ÇíÈÅ∏Êäû
   } catch (e) { console.error("„Ç∞„É´„Éº„Éó‰ΩúÊàê„Ç®„É©„Éº:", e); alert("„Ç∞„É´„Éº„Éó‰ΩúÊàêÂ§±Êïó: " + e.message); }
 }




 const emojis = ['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','ü§£','üòÇ','üôÇ','üôÉ','üòâ','üòä','üòá','ü•∞','üòç','ü§©','üòò','üòó','üòö','üòô','üòã','üòõ','üòú','ü§™','üòù','ü§ë','ü§ó','ü§≠','ü§´','ü§î','ü§ê','ü§®','üòê','üòë','üò∂','üòè','üòí','üôÑ','üò¨','ü§•','üòå','üòî','üò™','ü§§','üò¥','üò∑','ü§í','ü§ï','ü§¢','ü§Æ','ü§ß','ü•µ','ü•∂','üòµ','ü§Ø','ü§†','ü•≥','üòé','ü§ì','üßê','üòï','üòü','üôÅ','üòÆ','üòØ','üò≤','üò≥','ü•∫','üò¶','üòß','üò®','üò∞','üò•','üò¢','üò≠','üò±','üòñ','üò£','üò©','üò´','üò§','üò°','üò†','ü§¨','üòà','üëø','üíÄ','üëª','üëΩ','ü§ñ'];
 function initEmojiPicker() {
   if (!emojiPicker) return;
   emojiPicker.innerHTML = ''; // ÂàùÊúüÂåñÊôÇ„Å´„ÇØ„É™„Ç¢
   emojis.forEach(emoji => {
     const button = document.createElement('button');
     button.type = 'button'; button.className = 'emoji-button'; button.textContent = emoji;
     button.onclick = () => {
       if (!messageInput) return;
       const start = messageInput.selectionStart; const end = messageInput.selectionEnd;
       messageInput.value = messageInput.value.substring(0, start) + emoji + messageInput.value.substring(end);
       messageInput.focus();
       messageInput.setSelectionRange(start + emoji.length, start + emoji.length);
     };
     emojiPicker.appendChild(button);
   });
 }
 function handleToggleEmojiPicker() {
   if (emojiPicker) emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'grid' : 'none';
 }


 async function handleUpdateProfile() {
     if (!editUsernameInput || !editIconColorInput || !editBioInput || !currentUser) return;
     const newUsername = editUsernameInput.value.trim();
     const newColor = editIconColorInput.value;
     const newBio = editBioInput.value.trim();
     if (!newUsername) { alert("„É¶„Éº„Ç∂„ÉºÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"); return; }
     try {
         if (currentUser.displayName !== newUsername) {
           await currentUser.updateProfile({ displayName: newUsername });
         }
         await db.ref(`users/${currentUser.uid}`).update({
             username: newUsername, username_lower: newUsername.toLowerCase(),
             color: newColor, bio: newBio
         });
         alert("„Éó„É≠„Éï„Ç£„Éº„É´Êõ¥Êñ∞ÊàêÂäüÔºÅ");
     } catch (error) { console.error("„Éó„É≠„Éï„Ç£„Éº„É´Êõ¥Êñ∞„Ç®„É©„Éº:", error); alert("„Éó„É≠„Éï„Ç£„Éº„É´Êõ¥Êñ∞Â§±Êïó: " + error.message); }
 }


 async function handleUpdateGroupProfile() { // „Ç∞„É´„Éº„ÉóÂêçÊõ¥Êñ∞
     if (!currentRoomId || currentRoomType !== "group" || !editGroupNameInput) { alert("„Ç∞„É´„Éº„Éó„ÉÅ„É£„ÉÉ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"); return; }
     const newGroupName = editGroupNameInput.value.trim();
     if (!newGroupName) { alert("„Ç∞„É´„Éº„ÉóÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"); return; }
     try {
         await db.ref(`rooms/${currentRoomId}`).update({ name: newGroupName });
         alert("„Ç∞„É´„Éº„ÉóÂêçÊõ¥Êñ∞ÊàêÂäüÔºÅ");
         // rooms[currentRoomId] „ÅÆ name „ÇÇÊõ¥Êñ∞„Åó„Å¶ selectRoom „ÇíÂëº„Å∂
         if (rooms[currentRoomId]) {
           rooms[currentRoomId].name = newGroupName;
           selectRoom({ id: currentRoomId, ...rooms[currentRoomId] });
         }
     } catch (error) { console.error("„Ç∞„É´„Éº„ÉóÂêçÊõ¥Êñ∞„Ç®„É©„Éº:", error); alert("„Ç∞„É´„Éº„ÉóÂêçÊõ¥Êñ∞Â§±Êïó: " + error.message); }
 }


 function handleSearchUserToAddGroupMember() { // „Ç∞„É´„Éº„ÉóÁ∑®ÈõÜÊôÇ„ÅÆ„É°„É≥„Éê„ÉºËøΩÂä†
   const keyword = searchUserToAddGroupMemberInput.value.trim().toLowerCase();
   if (!groupMemberAddResultsDiv || !currentUser || !currentRoomData || currentRoomType !== 'group') return;
   groupMemberAddResultsDiv.innerHTML = "";
   if (!keyword) return;


   let usersFound = false;
   Object.entries(allRegisteredUsers).forEach(([uid, user]) => {
       if (currentRoomData.members[uid] || !user.username_lower) return; // Êó¢„Å´„É°„É≥„Éê„Éº„Åã„ÄÅ„É¶„Éº„Ç∂„ÉºÂêç„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÈô§Â§ñ
       if (user.username_lower.includes(keyword)) {
           usersFound = true;
           const div = document.createElement("div");
           div.className = "searchUserItem"; div.textContent = user.username;
           div.onclick = async () => {
               if (confirm(`${user.username} „Çí„Ç∞„É´„Éº„Éó„Å´ËøΩÂä†„Åó„Åæ„Åô„ÅãÔºü`)) {
                   await addMemberToGroup(currentRoomId, uid);
                   searchUserToAddGroupMemberInput.value = ""; groupMemberAddResultsDiv.innerHTML = "";
               }
           };
           groupMemberAddResultsDiv.appendChild(div);
       }
   });
   if (!usersFound) groupMemberAddResultsDiv.textContent = "Ë©≤ÂΩì„É¶„Éº„Ç∂„Éº„Å™„Åó";
 }


 async function addMemberToGroup(roomId, uidToAdd) {
     try {
         await db.ref(`rooms/${roomId}/members/${uidToAdd}`).set(true);
         alert("„É°„É≥„Éê„ÉºËøΩÂä†ÊàêÂäü„ÄÇ");
     } catch (error) { console.error("„É°„É≥„Éê„ÉºËøΩÂä†„Ç®„É©„Éº:", error); alert("„É°„É≥„Éê„ÉºËøΩÂä†Â§±Êïó: " + error.message); }
 }


 function updateGroupMembersList(members) {
     if (!currentGroupMembersList || !currentUser || !allRegisteredUsers) return;
     currentGroupMembersList.innerHTML = '';
     const memberUids = Object.keys(members || {});
     memberUids.forEach(memberUid => {
         const memberInfo = allRegisteredUsers[memberUid];
         if (memberInfo) {
             const initial = memberInfo.username.charAt(0).toUpperCase();
             const color = memberInfo.color || getRandomColor();
             const listItem = document.createElement('li');
             listItem.className = 'group-member-item';
             listItem.innerHTML = `
                 <div style="display: flex; align-items: center;">
                     <div class="user-icon chat-user-icon" style="background-color: ${escapeHTML(color)};">${escapeHTML(initial)}</div>
                     <span>${escapeHTML(memberInfo.username)} ${memberUid === currentRoomData?.createdBy ? '(‰ΩúÊàêËÄÖ)' : ''} ${memberUid === currentUser.uid ? '(Ëá™ÂàÜ)' : ''}</span>
                 </div>`;
             // Ëá™ÂàÜËá™Ë∫´„Åß„Å™„ÅÑ„ÄÅ„Åã„Å§„É°„É≥„Éê„Éº„Åå2‰∫∫‰ª•‰∏ä„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÂâäÈô§„Éú„Çø„É≥„ÇíË°®Á§∫ (‰ΩúÊàêËÄÖ„ÅØÂâäÈô§„Åß„Åç„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã„ÅÆ„ÇÇ„ÅÇ„Çä)
             if (memberUid !== currentUser.uid && memberUids.length > 1 && memberUid !== currentRoomData?.createdBy) {
                 const removeBtn = document.createElement('button');
                 removeBtn.textContent = 'ÂâäÈô§'; removeBtn.type = 'button';
                 removeBtn.onclick = async () => {
                     if (confirm(`${memberInfo.username} „Çí„Ç∞„É´„Éº„Éó„Åã„ÇâÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                         await removeMemberFromGroup(currentRoomId, memberUid);
                     }
                 };
                 listItem.appendChild(removeBtn);
             }
             currentGroupMembersList.appendChild(listItem);
         }
     });
 }


 async function removeMemberFromGroup(roomId, uidToRemove) {
     try {
         // „É°„É≥„Éê„Éº„Åå1‰∫∫„Åó„Åã„ÅÑ„Å™„Åè„Å™„ÇãÂ†¥Âêà„ÅØ„É´„Éº„É†„Åî„Å®ÂâäÈô§„Åô„Çã„Å™„Å©„ÅÆËÄÉÊÖÆ„ÇÇÂèØËÉΩ
         await db.ref(`rooms/${roomId}/members/${uidToRemove}`).remove();
         alert("„É°„É≥„Éê„ÉºÂâäÈô§ÊàêÂäü„ÄÇ");
         // currentRoomData.members„Åã„Çâ„ÇÇÂâäÈô§„Åó„ÄÅUI„ÇíÊõ¥Êñ∞
         if (rooms[roomId] && rooms[roomId].members) {
           delete rooms[roomId].members[uidToRemove];
           selectRoom({id: roomId, ...rooms[roomId]}); // UIÊõ¥Êñ∞
         }
     } catch (error) { console.error("„É°„É≥„Éê„ÉºÂâäÈô§„Ç®„É©„Éº:", error); alert("„É°„É≥„Éê„ÉºÂâäÈô§Â§±Êïó: " + error.message); }
 }


 async function handleRequestGroupDeletion() {
     if (!currentRoomId || currentRoomType !== "group" || !currentUser) { alert("„Ç∞„É´„Éº„Éó„ÉÅ„É£„ÉÉ„Éà„ÇíÈÅ∏Êäû„ÄÇ"); return; }
     if (!confirm("Êú¨ÂΩì„Å´„Åì„ÅÆ„Ç∞„É´„Éº„Éó„ÅÆÂâäÈô§„É™„ÇØ„Ç®„Çπ„Éà„ÇíÈñãÂßã„Åó„Åæ„Åô„ÅãÔºü")) return;
     try {
         const deletionRef = db.ref(`rooms/${currentRoomId}/deletionRequest`);
         const snapshot = await deletionRef.once('value');
         if (snapshot.exists()) { alert("Êó¢„Å´ÂâäÈô§„É™„ÇØ„Ç®„Çπ„Éà„ÅåÈñãÂßã„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ"); return; }
         await deletionRef.set({
             requestedBy: currentUser.uid, requestedAt: firebase.database.ServerValue.TIMESTAMP,
             votes: { [currentUser.uid]: true }
         });
         alert("„Ç∞„É´„Éº„ÉóÂâäÈô§„É™„ÇØ„Ç®„Çπ„ÉàÈñãÂßã„ÄÇ‰ªñ„ÅÆ„É°„É≥„Éê„Éº„ÅÆË≥õÊàê„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ");
     } catch (error) { console.error("„Ç∞„É´„Éº„ÉóÂâäÈô§„É™„ÇØ„Ç®„Çπ„Éà„Ç®„É©„Éº:", error); alert("„É™„ÇØ„Ç®„Çπ„ÉàÂ§±Êïó: " + error.message); }
 }


 let groupDeletionListener = null;
 function setupGroupDeletionListener(roomId) {
     if (!groupDeletionStatusDiv || !btnRequestGroupDeletion || !currentUser) return;
     const deletionRef = db.ref(`rooms/${roomId}/deletionRequest`);
    
     // Êó¢Â≠ò„ÅÆ„É™„Çπ„Éä„Éº„ÇíËß£Èô§
     if (groupDeletionListener) {
         deletionRef.off('value', groupDeletionListener);
     }


     groupDeletionListener = async (snapshot) => { // „Ç≥„Éº„É´„Éê„ÉÉ„ÇØ„Çí‰øùÊåÅ
         const deletionRequest = snapshot.val();
         groupDeletionStatusDiv.innerHTML = '';
         groupDeletionStatusDiv.style.display = 'none';
         btnRequestGroupDeletion.style.display = 'block';


         if (deletionRequest && currentRoomData && currentRoomData.members) { // currentRoomData.members„ÅÆÂ≠òÂú®Á¢∫Ë™ç
             groupDeletionStatusDiv.style.display = 'block';
             btnRequestGroupDeletion.style.display = 'none';


             const membersInRoom = Object.keys(currentRoomData.members).length;
             const votesCount = Object.keys(deletionRequest.votes || {}).length;
             // ÈÅéÂçäÊï∞„Åß„ÅØ„Å™„Åè„ÄÅÂÖ®Âì°„ÅÆË≥õÊàê„ÅåÂøÖË¶Å„Å™‰ªïÊßò„Å´Â§âÊõ¥„Åô„ÇãÂ†¥Âêà„Å™„Å©„ÄÅÊù°‰ª∂„ÅØË™øÊï¥ÂèØËÉΩ
             const requiredVotes = membersInRoom > 1 ? Math.floor(membersInRoom / 2) + 1 : 1; // 1‰∫∫„ÅÆÂ†¥Âêà„ÅØ1Á•®„ÅßÂèØ


             let statusText = `„Ç∞„É´„Éº„ÉóÂâäÈô§„É™„ÇØ„Ç®„Çπ„Éà‰∏≠: ${votesCount} / ${requiredVotes} Á•®`;


             if (votesCount >= requiredVotes) {
                 statusText += `<br><strong>ÂâäÈô§Êù°‰ª∂ÊàêÁ´ãÔºÅ„Ç∞„É´„Éº„Éó„ÇíÂâäÈô§„Åó„Åæ„Åô„ÄÇ</strong>`;
                 groupDeletionStatusDiv.innerHTML = statusText;
                 await deleteGroup(roomId);
             } else {
                 if (!deletionRequest.votes[currentUser.uid]) {
                     statusText += `<br><button id="btnVoteForDeletion" type="button">Ë≥õÊàê</button> <button id="btnRejectDeletion" class="reject" type="button">ÂèçÂØæ</button>`;
                 } else {
                     statusText += `<br>„ÅÇ„Å™„Åü„ÅØÊó¢„Å´Ë≥õÊàê„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ`;
                 }
                 groupDeletionStatusDiv.innerHTML = statusText;


                 const btnVote = document.getElementById('btnVoteForDeletion');
                 const btnReject = document.getElementById('btnRejectDeletion');
                 if (btnVote) btnVote.onclick = async () => { db.ref(`rooms/${roomId}/deletionRequest/votes/${currentUser.uid}`).set(true); };
                 if (btnReject) btnReject.onclick = async () => { if (confirm("ÂâäÈô§„É™„ÇØ„Ç®„Çπ„Éà„Å´ÂèçÂØæ„Åó„Åæ„Åô„ÅãÔºü„É™„ÇØ„Ç®„Çπ„Éà„ÅåÂèñ„ÇäÊ∂à„Åï„Çå„Åæ„Åô„ÄÇ")) { db.ref(`rooms/${roomId}/deletionRequest`).remove(); }};
             }
         }
     };
     deletionRef.on('value', groupDeletionListener, error => console.error("Deletion listener error:", error));
 }




 async function deleteGroup(roomIdToDelete) {
     try {
         await db.ref(`rooms/${roomIdToDelete}`).remove();
         alert("„Ç∞„É´„Éº„Éó„ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„Åü„ÄÇ");
         if (currentRoomId === roomIdToDelete) { // ÁèæÂú®Ë°®Á§∫‰∏≠„ÅÆ„É´„Éº„É†„ÅåÂâäÈô§„Åï„Çå„ÅüÂ†¥Âêà
             currentRoomId = null; currentRoomData = null; currentRoomType = null;
             clearChat();
             if (groupEditForm) groupEditForm.style.display = 'none';
             if (myProfileSection) myProfileSection.style.display = 'block';
             // isRoomManuallySelected = false; // Ëá™ÂãïÈÅ∏Êäû„ÇíË®±ÂèØ„Åô„Çã„Åü„ÇÅ„Å´„É™„Çª„ÉÉ„Éà„ÇÇÊ§úË®é
             // loadRooms(currentUser.uid); // „É´„Éº„É†„É™„Çπ„Éà„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„ÄÅ„ÇÇ„Åó„ÅÇ„Çå„Å∞Âà•„ÅÆ„É´„Éº„É†„ÇíËá™ÂãïÈÅ∏Êäû
         }
         // rooms „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Åã„Çâ„ÇÇÂâäÈô§
         delete rooms[roomIdToDelete];
         renderRoomList(); // „É´„Éº„É†„É™„Çπ„Éà„ÇíÂÜçÊèèÁîª
     } catch (error) { console.error("„Ç∞„É´„Éº„ÉóÂâäÈô§„Ç®„É©„Éº:", error); alert("„Ç∞„É´„Éº„ÉóÂâäÈô§Â§±Êïó: " + error.message); }
 }


 function clearRoomList() { if (roomListDiv) roomListDiv.innerHTML = ""; }
 function clearChat() {
   if (chatBox) chatBox.innerHTML = "„ÉÅ„É£„ÉÉ„Éà„É´„Éº„É†„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
   if (roomTitle) roomTitle.textContent = "„ÉÅ„É£„ÉÉ„ÉàÁîªÈù¢";
 }
 function clearProfile() { // „É≠„Ç∞„Ç¢„Ç¶„ÉàÊôÇ„Å´Ëá™ÂàÜ„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´Ë°®Á§∫„Çí„ÇØ„É™„Ç¢
   if (myProfileIcon) { myProfileIcon.innerHTML = ""; myProfileIcon.style.backgroundColor = ""; }
   if (myUsernameDisplay) myUsernameDisplay.textContent = "";
   if (myEmailDisplay) myEmailDisplay.textContent = "";
   if (myBioDisplay) myBioDisplay.textContent = "";
   if (editUsernameInput) editUsernameInput.value = "";
   if (editIconColorInput) editIconColorInput.value = "#000000";
   if (editBioInput) editBioInput.value = "";
 }


 function escapeHTML(str) {
   if (typeof str !== 'string') return '';
   return str.replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m]));
 }
 </script>


</body>
</html>

